<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WAR! Web Map (Geographical Prototype)</title>
<style>
:root{
  --paper:#efe3c8;
  --paper2:#e6d7b6;
  --ink:#2b2418;
  --muted:#5a503f;
  --border:#b59f6a;
  --panel:rgba(245,234,211,.92);
  --shadow:0 12px 30px rgba(0,0,0,.18);
  --radius:14px;
  --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
  --sans: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
html,body{height:100%}
body{
  margin:0;
  color:var(--ink);
  background:
    radial-gradient(1200px 900px at 20% 10%, rgba(255,255,255,.65), transparent 60%),
    radial-gradient(900px 700px at 80% 20%, rgba(255,255,255,.35), transparent 55%),
    linear-gradient(180deg, var(--paper), var(--paper2));
  font-family:var(--sans);
}
/* Layout */
header{
  position:sticky;top:0;z-index:20;
  background:var(--panel);
  border-bottom:2px solid rgba(0,0,0,.10);
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.header-inner{max-width:1200px;margin:0 auto;padding:12px 14px}
h1{margin:0;font-family:var(--serif);letter-spacing:.3px;font-size:18px}
.sub{margin-top:3px;color:var(--muted);font-size:12px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.18);background:rgba(255,255,255,.45)}
label{font-size:12px;color:var(--muted)}
select,button,input{
  font-size:13px;
  border:1px solid rgba(0,0,0,.22);
  border-radius:10px;
  padding:7px 9px;
  background:rgba(255,255,255,.75);
  color:var(--ink);
}
button{cursor:pointer}
button:active{transform:scale(.99)}
main{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns: 1.6fr 1fr;gap:14px}
@media (max-width: 980px){ main{grid-template-columns:1fr;} }

/* Map panel */
.panel{
  background:rgba(255,255,255,.35);
  border:2px solid rgba(0,0,0,.12);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.panel h2{
  margin:0;
  padding:10px 12px;
  font-family:var(--serif);
  font-size:15px;
  border-bottom:1px solid rgba(0,0,0,.12);
  background:rgba(255,255,255,.30);
}
.mapwrap{position:relative}
svg{width:100%;height:auto;display:block}
/* Map styling */
.ocean{fill:#c9d6de;opacity:.55}
.land{fill:#f6edd5;opacity:.35}
.coast{fill:none;stroke:rgba(43,36,24,.30);stroke-width:3}
.graticule{stroke:rgba(43,36,24,.08);stroke-width:1}
.terr{stroke:rgba(43,36,24,.65);stroke-width:2;cursor:pointer;transition:filter .1s ease, opacity .1s ease}
.terr:hover{filter:brightness(1.06)}
.terr.selected{stroke-width:4;filter:drop-shadow(0 3px 4px rgba(0,0,0,.25))}
.terr.neighbor{stroke-width:4;stroke-dasharray:8 5}
.terr.unknown{opacity:.25}
.terr.rumoured{opacity:.40}
.terr.observed{opacity:.65}
.terr.scouted{opacity:.90}
.text-label{font-family:var(--serif);font-size:18px;fill:rgba(43,36,24,.85);pointer-events:none}
.id-label{font-family:var(--mono);font-size:14px;fill:rgba(43,36,24,.70);pointer-events:none}
.pin{fill:rgba(43,36,24,.85);stroke:rgba(255,255,255,.6);stroke-width:2}
.pin-label{font-family:var(--serif);font-size:14px;fill:rgba(43,36,24,.90);pointer-events:none}
/* Side panel */
.card{padding:12px}
.kv{width:100%;border-collapse:collapse;border:1px solid rgba(0,0,0,.16);border-radius:12px;overflow:hidden;background:rgba(255,255,255,.50)}
.kv td{padding:8px 10px;border-top:1px solid rgba(0,0,0,.10);vertical-align:top;font-size:13px}
.kv td.k{width:34%;color:var(--muted)}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
.badge{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.18);background:rgba(255,255,255,.55);font-size:12px}
.dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.25)}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px dashed rgba(0,0,0,.22);margin:12px 0}
fieldset{border:1px dashed rgba(0,0,0,.24);border-radius:12px;padding:10px}
legend{padding:0 6px;font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.row > *{flex:1 1 160px}
.code{font-family:var(--mono)}
.notice{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.18);background:rgba(255,255,255,.55)}
.footer{padding:10px 12px;font-size:12px;color:var(--muted);border-top:1px solid rgba(0,0,0,.12);background:rgba(255,255,255,.26)}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <h1>WAR! Web Map — Geographical Prototype</h1>
    <div class="sub">WW2 atlas style • GM mode + Player mode • Designed for GitHub Pages • Generated 2026-01-09</div>

    <div class="toolbar">
      <span class="pill">
        <label for="theatreSel">Theatre</label>
        <select id="theatreSel">
          <option value="theatre-we">Western Europe</option>
          <option value="theatre-ee">Eastern Europe</option>
          <option value="theatre-na">North Africa</option>
          <option value="theatre-pac">Pacific</option>
        </select>
      </span>

      <span class="pill">
        <label for="modeSel">Mode</label>
        <select id="modeSel">
          <option value="gm">GM (full)</option>
          <option value="player">Player (fog)</option>
        </select>
      </span>

      <span class="pill">
        <label for="factionSel">Player Faction</label>
        <select id="factionSel">
          <option value="A">Faction A</option>
          <option value="B">Faction B</option>
          <option value="C">Faction C</option>
          <option value="D">Faction D</option>
          <option value="E">Faction E</option>
          <option value="F">Faction F</option>
        </select>
      </span>

      <span class="pill">
        <label for="showPins">Pins</label>
        <select id="showPins">
          <option value="on">On</option>
          <option value="off">Off</option>
        </select>
      </span>

      <span class="pill">
        <button id="btnExportTerr">Export Territories CSV</button>
        <button id="btnExportAdj">Export Adjacency CSV</button>
      </span>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <h2 id="mapTitle">Map</h2>
    <div class="mapwrap" id="mapWrap"></div>
    <div class="footer">
      Tip: Click a territory to open its card. In GM mode you can edit owner/supply/partisan + per‑faction visibility.
    </div>
  </section>

  <aside class="panel">
    <h2>Territory Card</h2>
    <div class="card" id="infoCard">
      <div class="notice">
        <div class="small">Select a territory to view details.</div>
      </div>
      <hr/>
      <div class="notice">
        <div><b>Fog of War states</b></div>
        <div class="small">Unknown → Rumoured → Observed → Scouted → Owned</div>
        <div class="small">Player mode hides or limits info based on your selected faction.</div>
      </div>
    </div>
  </aside>
</main>

<script>
const WAR_DATA = {"theatre-we": {"name": "Western Europe 14 territories", "territories": [{"id": "WE-01", "name": "Southern England", "info": {"Terrain": "Urban / Rural / Coastal", "Strategic Role": "Homeland / Command Hub", "Special": "+1 Air Operations\nFaster reinforcement to coastal territories", "Notes": "If lost, faction suffers major morale & logistics penalties.", "AdjacencyList": ["WE-02"]}}, {"id": "WE-02", "name": "Northern France (Normandy)", "info": {"Terrain": "Rural / Coastal", "Special Resource": "Invasion Beaches", "Special Rules": "Coastal battles allowed\nFortifications cheaper for defender", "Narrative": "Amphibious assaults, airborne drops.", "AdjacencyList": ["WE-01", "WE-03"]}}, {"id": "WE-03", "name": "Paris Basin", "info": {"Terrain": "Urban", "Resource": "Political Capital", "Special": "+1 Reputation per turn if controlled\nLosing it causes faction-wide unrest", "AdjacencyList": ["WE-02", "WE-04"]}}, {"id": "WE-04", "name": "Low Countries (Belgium\u2013Netherlands)", "info": {"Terrain": "Urban / Rivers", "Special": "Logistics Corridor", "Rules": "Units moving through here cost \u22121 Supply\nVulnerable to blitz-style breakthroughs", "AdjacencyList": ["WE-03", "WE-05"]}}, {"id": "WE-05", "name": "Ruhr Industrial Zone", "info": {"Terrain": "Urban / Industrial", "Resource": "Heavy Industry", "Special": "\u22121 cost to vehicles & artillery\nBombing events more common", "AdjacencyList": ["WE-04", "WE-06"]}}, {"id": "WE-06", "name": "Western Germany (Rhine)", "info": {"Terrain": "Urban / River", "Special": "Defensive Line", "Rules": "Defenders may deploy extra fortifications\nRiver crossing penalties apply", "AdjacencyList": ["WE-05", "WE-07"]}}, {"id": "WE-07", "name": "Southern Germany (Bavaria)", "info": {"Terrain": "Rural / Hills", "Resource": "Training Grounds", "Special": "Units gain XP faster\nVeteran upgrades cheaper", "AdjacencyList": ["WE-06", "WE-08"]}}, {"id": "WE-08", "name": "Northern Italy", "info": {"Terrain": "Urban / Mountains", "Special": "Chokepoints", "Rules": "Narrow fronts\nInfantry favored over armor", "AdjacencyList": ["WE-07", "WE-09"]}}, {"id": "WE-09", "name": "Central Italy", "info": {"Terrain": "Urban / Rural", "Resource": "Political Influence", "Special": "Diplomacy actions cheaper here", "AdjacencyList": ["WE-08", "WE-10"]}}, {"id": "WE-10", "name": "Iberian Peninsula", "info": {"Terrain": "Rural / Urban", "Special": "Neutral Influence Zone", "Rules": "Diplomacy-heavy\nEspionage actions gain bonuses", "AdjacencyList": ["WE-09", "WE-11"]}}, {"id": "WE-11", "name": "Western Mediterranean Coast", "info": {"Terrain": "Coastal", "Special Resource": "Naval Control", "Rules": "Enables blockades\nCoastal raids possible", "AdjacencyList": ["WE-10", "WE-12"]}}, {"id": "WE-12", "name": "Scandinavia (South)", "info": {"Terrain": "Forest / Snow", "Resource": "Tungsten / Steel", "Special": "Rare Materials", "Rules": "Winter rules apply part-year", "AdjacencyList": ["WE-11", "WE-13"]}}, {"id": "WE-13", "name": "Atlantic Sea Lanes", "info": {"Terrain": "Naval Zone", "Special": "Convoy Warfare", "Rules": "Disrupt supply\nSubmarine & air actions matter", "AdjacencyList": ["WE-12", "WE-14"]}}, {"id": "WE-14", "name": "Alpine Region", "info": {"Terrain": "Mountains", "Special": "Natural Fortress", "Rules": "Armor severely limited\nFortifications very effective\nEastern Europe", "AdjacencyList": ["WE-13"]}}]}, "theatre-ee": {"name": "Eastern Europe 14 territories", "territories": [{"id": "EE-01", "name": "Western Poland", "info": {"Terrain": "Plains / Urban", "Special": "Invasion Corridor", "Rules": "Large battles likely\nReinforcements common", "AdjacencyList": ["EE-02"]}}, {"id": "EE-02", "name": "Eastern Poland", "info": {"Terrain": "Forest / Rural", "Special": "Partisan Activity", "Rules": "Supply disruption events", "AdjacencyList": ["EE-01", "EE-03"]}}, {"id": "EE-03", "name": "Baltic States", "info": {"Terrain": "Forest / Coastal", "Resource": "Ports & Timber", "Rules": "Amphibious + winter overlap", "AdjacencyList": ["EE-02", "EE-04"]}}, {"id": "EE-04", "name": "Belarus", "info": {"Terrain": "Forest / Marsh", "Special": "Attrition Zone", "Rules": "Movement penalties\nInfantry favored", "AdjacencyList": ["EE-03", "EE-05"]}}, {"id": "EE-05", "name": "Ukraine (West)", "info": {"Terrain": "Plains", "Resource": "Grain", "Special": "Improves supply efficiency", "AdjacencyList": ["EE-04", "EE-06"]}}, {"id": "EE-06", "name": "Ukraine (East \u2013 Industry)", "info": {"Terrain": "Urban / Industrial", "Resource": "Factories", "Special": "Vehicle & artillery production bonuses", "AdjacencyList": ["EE-05", "EE-07"]}}, {"id": "EE-07", "name": "Crimea", "info": {"Terrain": "Coastal", "Special": "Black Sea Control", "Rules": "Naval & coastal siege actions", "AdjacencyList": ["EE-06", "EE-08"]}}, {"id": "EE-08", "name": "Moscow Region", "info": {"Terrain": "Urban", "Special": "Capital Territory", "Rules": "Massive morale impact if lost\nDefensive bonuses", "AdjacencyList": ["EE-07", "EE-09"]}}, {"id": "EE-09", "name": "Leningrad Region", "info": {"Terrain": "Urban / Coastal", "Special": "Siege Warfare", "Rules": "Long battles common\nSupply starvation mechanics", "AdjacencyList": ["EE-08", "EE-10"]}}, {"id": "EE-10", "name": "Smolensk Corridor", "info": {"Terrain": "Plains / Forest", "Special": "Strategic Highway", "Rules": "Faster movement\nHigh contest value", "AdjacencyList": ["EE-09", "EE-11"]}}, {"id": "EE-11", "name": "Caucasus", "info": {"Terrain": "Mountains", "Resource": "Oil", "Special": "Vehicles cheaper\nLosing it cripples armor", "AdjacencyList": ["EE-10", "EE-12"]}}, {"id": "EE-12", "name": "Stalingrad Region", "info": {"Terrain": "Urban", "Special": "Symbolic Battlefield", "Rules": "Reputation & Momentum heavily affected", "AdjacencyList": ["EE-11", "EE-13"]}}, {"id": "EE-13", "name": "Arctic Front", "info": {"Terrain": "Arctic / Snow", "Special": "Extreme Weather", "Rules": "Winter warfare mandatory\nElite troops shine", "AdjacencyList": ["EE-12", "EE-14"]}}, {"id": "EE-14", "name": "Volga Industrial Belt", "info": {"Terrain": "Industrial", "Special": "Deep Reserves", "Rules": "Hard to cut off\nReinforcement depth advantage\nNorth Africa\nNORTH AFRICA THEATRE \u2014 14 TERRITORIES", "AdjacencyList": ["EE-13"]}}]}, "theatre-na": {"name": "North Africa 14 territories", "territories": [{"id": "NA-ALGCO", "name": "Western Mediterranean Coast", "info": {"Theatre": "North Africa", "Terrain": "Coastal / Urban (Algeria-Tunisia corridor)", "Special Resource": "Naval Control Node", "Supply Hub": "Yes (if ports controlled)", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-BNGH", "name": "Benghazi", "info": {"Theatre": "North Africa", "Terrain": "Coastal / Desert", "Special Resource": "Oil (local depot)", "Supply Hub": "No", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-ELAG", "name": "El Agheila", "info": {"Theatre": "North Africa", "Terrain": "Coastal Desert / Sand Dunes", "Special Resource": "Rail Link Node", "Supply Hub": "No", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-ELAL", "name": "El Alamein", "info": {"Theatre": "North Africa", "Terrain": "Desert / Coastal", "Special Resource": "Fortification Focus", "Supply Hub": "No", "Fort Slots": "3", "Starting Owner": "Neutral", "Starting Platoons": "2", "AdjacencyList": []}}, {"id": "NA-FEZ", "name": "Fezzan", "info": {"Theatre": "North Africa", "Terrain": "Desert / Oasis", "Special Resource": "Caravan / Trade Node", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-SDES", "name": "Southern Desert", "info": {"Theatre": "North Africa", "Terrain": "Harsh Desert / Sand Sea", "Special Resource": "Rare Minerals (rumour/discovery)", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "NA-SIOA", "name": "Siwa Oasis", "info": {"Theatre": "North Africa", "Terrain": "Oasis / Desert", "Special Resource": "Local Water Supply (small)", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "NA-TBRG", "name": "Tobruk Hinterland (internal desert tile to break long front)", "info": {"Theatre": "North Africa", "Terrain": "Desert / Scrub", "Special Resource": "Supply Cache (small)", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-TBRK", "name": "Tobruk", "info": {"Theatre": "North Africa", "Terrain": "Coastal / Desert", "Special Resource": "Port", "Supply Hub": "Yes", "Fort Slots": "2", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-TNS", "name": "Tunis", "info": {"Theatre": "North Africa", "Terrain": "Coastal / Urban", "Special Resource": "Port / Political Centre", "Supply Hub": "Yes", "Fort Slots": "2", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-TRPL", "name": "Tripoli", "info": {"Theatre": "North Africa", "Terrain": "Coastal / Urban", "Special Resource": "Port / Industry (small)", "Supply Hub": "Yes", "Fort Slots": "2", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "NA-WDES", "name": "Western Desert", "info": {"Theatre": "North Africa", "Terrain": "Open Desert (plateau)", "Special Resource": "None (but movement corridor)", "Supply Hub": "No", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "2", "AdjacencyList": []}}, {"id": "NA-TOBR", "name": "Alexandria / Suez Approaches", "info": {"Theatre": "North Africa (Egyptian littoral)", "Terrain": "Coastal / Urban / Canal Approaches", "Special Resource": "Strategic Canal Access (Suez-like)", "Supply Hub": "Yes", "Fort Slots": "2", "Starting Owner": "Neutral", "Starting Platoons": "2", "AdjacencyList": []}}, {"id": "NA-CORPS", "name": "Cairo Corridor", "info": {"Theatre": "North Africa / Middle East border", "Terrain": "Urban / Desert Oasis Route", "Special Resource": "Manpower / Recruitment Pool", "Supply Hub": "Yes", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "2", "AdjacencyList": []}}]}, "theatre-pac": {"name": "Pacific 14 territories", "territories": [{"id": "PA-CAROL", "name": "Caroline Islands (Truk complex)", "info": {"Theatre": "Pacific", "Terrain": "Atolls / Coastal", "Special Resource": "Naval Anchorage (Truk-style)", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-FIJI", "name": "Fiji / Pacific Islands", "info": {"Theatre": "Pacific", "Terrain": "Island chain / Coastal", "Special Resource": "Convoy Waypoint", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-GILB", "name": "Gilbert Islands (Tarawa)", "info": {"Theatre": "Pacific", "Terrain": "Coral Atoll / Coastal", "Special Resource": "Beachhead Potential", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-GUAM", "name": "Guam / Palau", "info": {"Theatre": "Pacific", "Terrain": "Coastal / Tropical", "Special Resource": "Port / Forward Base", "Supply Hub": "Yes (if captured & developed)", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-MARI", "name": "Marianas", "info": {"Theatre": "Pacific", "Terrain": "Island / Coastal", "Special Resource": "Airbase Potential", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-MARSH", "name": "Marshall Islands", "info": {"Theatre": "Pacific", "Terrain": "Atolls / Coastal", "Special Resource": "Airstrip potential / Sea lane control", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-MIDW", "name": "Midway", "info": {"Theatre": "Pacific", "Terrain": "Small Atoll / Coastal", "Special Resource": "Airstrip / Naval Transit", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-NEWG", "name": "New Guinea (Papua)", "info": {"Theatre": "Pacific", "Terrain": "Jungle / Mountain", "Special Resource": "Rare Resources (rumour)", "Supply Hub": "No", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "PA-PHIL", "name": "Philippines (Luzon)", "info": {"Theatre": "Pacific", "Terrain": "Coastal / Jungle / Urban", "Special Resource": "Major Port / Airfield", "Supply Hub": "Yes", "Fort Slots": "2", "Starting Owner": "Neutral", "Starting Platoons": "2", "AdjacencyList": []}}, {"id": "PA-SOLO", "name": "Solomon Islands", "info": {"Theatre": "Pacific", "Terrain": "Island chain / Jungle / Coastal", "Special Resource": "Naval Staging Point", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "PA-WAKE", "name": "Wake / Johnston", "info": {"Theatre": "Pacific", "Terrain": "Atoll / Coastal", "Special Resource": "Radar/Airstrip Node", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "AdjacencyList": []}}, {"id": "PA-FORM", "name": "Formosa / Taiwan", "info": {"Theatre": "Pacific / East Asia", "Terrain": "Coastal / Urban", "Special Resource": "Industry / Port", "Supply Hub": "Yes", "Fort Slots": "2", "Starting Owner": "Neutral", "Starting Platoons": "2", "AdjacencyList": []}}, {"id": "PA-AUSN", "name": "Northern Australia (Darwin/NT region)", "info": {"Theatre": "Pacific / Australasian", "Terrain": "Coastal / Savanna", "Special Resource": "Supply & Repair Hub (regional)", "Supply Hub": "Yes", "Fort Slots": "1", "Starting Owner": "Neutral", "Starting Platoons": "1", "AdjacencyList": []}}, {"id": "PA-SEA", "name": "Sea Lanes & Convoy Routes (abstract tile)", "info": {"Theatre": "Pacific (Naval Zone)", "Terrain": "Open Sea (naval)", "Special Resource": "Convoy / Trade route control", "Supply Hub": "No", "Fort Slots": "0", "Starting Owner": "Neutral", "Starting Platoons": "0", "Air Defence": "If Airfields & Air Superiority present, add \u22122 to enemy air strike roll.\n26.5 Artillery & Bombardment on Tactical Missions", "Allocate Forces": "Invader picks up to allowed force; defender receives garrison (1 smaller platoon or static crew). Specialist units allowed only if prerequisites met (e.g., Paras require Air research & airfield).", "Assassinate/ Capture General": "Risky; capture yields high political leverage; failure triggers world event.", "Attack": "Force commitment; attacker may play Bolt Action or request Operational Resolution. Attacker loses ability to hold future rounds without reinforcement.", "Battle At Leningrad Approaches": "Attacker spends 1 Industry + 1 Momentum for Tactical Bombardment. Roll D12 + modifier yields 10 (success). Defender\u2019s pre-game bunker reduces by 1 (bunker destroyed). Attacker gets deployment advantage. However, D12 civilian check result 2 \u2192 civilian casualties \u2192 Reputation \u22121. Later strategic bombing of a factory was attempted: cost 4 Industry + 2 Fuel, D20 success but triggered global diplomatic table \u2192 neutral embargo attempt.", "Board Size": "2\u00d72 ft or 3\u00d73 ft (default 2\u00d72 for raids).", "Bombard": "Spend Industry/Fuel or pre-allocated bombard assets to apply pre-battle effects (see \u00a726).", "Casualty Abstraction": "Use Bolt Action normal resolution; apply Campaign Attrition rules after mission.", "Choose Site": "Territory or quarter-tile. Place mission markers (objective, approach lanes, exit zone).", "Civilian Casualty Risk": "Each bombard roll (see below) 1\u20132 on D12: civilian casualty event \u2192 Reputation \u22121.", "Cost": "3 Industry + 2 Fuel (air) or 4 Industry (naval/combined) per action. Research/Skill trees may reduce cost.", "Counterbattery": "Defender may attempt to neutralize incoming barrage by spending local Artillery asset or Intel (recon reveals battery location). Counterbattery roll (D12) subtracts from bombard roll.", "Declare Intel": "Attacker may spend Intel to gain information (reveal one defender platoon type). Defender may spend Intel for ambush markers.", "Defender Victory": "Defender +2 XP; +1 Reputation if civilian population protected.\n23.5 Mission Types (short list \u2014 use GM table for variety)\n(Use the D12 Mission Table in \u00a724 for random generation.)", "Duration": "Effects apply next Strategic Phase; target suffers \u22121 Industry (or disabled) for 1\u20133 turns depending on success and seed-roll.", "Each Contiguous Turn A Territory Remains Contested Imposes Rising Costs": "Turn 1 (initial): No added cost (standard).\nTurn 2: Supply drain increases: all involved platoons treat supply as one level worse (Supplied\u2192Strained).\nTurn 3: Civilian unrest increases +1 in the territory if populated territories; neutral factions notice.\nTurn 4: Fatigue: each involved platoon loses one Condition step if they fought previous turn or attempted heavy recon. If still unresolved and both sides refuse to yield, the battle becomes a Prolonged Engagement (see \u00a725.8).\nThese stacking costs prevent indefinite standoffs.\n25.5 Intelligence & Waiting", "Escape / Exfiltrate": "Attacker must exit with unit/token to claim full reward.", "Examples": "Sabotage Railway (Demolition): Destroy supply node \u2192 -1 Industry output in theatre for 1 turn.\nCapture Documents (Intel): Gain 2 Intel, + reveal of one research node (if present).", "Failure To Extract": "Objective nullified; attacker loses additional Condition step.\n23.7 Special Rules & Constraints", "Force Size": "1\u20132 platoons (or the campaign\u2019s equivalent of 150\u2013500 points).", "Fortification Damage": "Reduce one fortification\u2019s effectiveness by 1 (destroy if already damaged).", "Full Mission Success": "Attacker gains +4 XP spread among participating platoons; +1 Intel token; +1 Momentum.\nPartial success (objective damaged but not removed / enemy exfiltrates with some losses): +2 XP; +1 Momentum.", "Hold": "Maintain position, improve defenses (+1 fortification effect if fort slot present), spend no movement.", "If Both Choose Attack": "Battle must occur this Operations/Resolution sequence (tabletop or Operational Resolution).", "If Neither Chooses Attack": "Territory remains contested; go to end-turn contested consequences (R-25.6). Repeat each turn until resolved or paused.\n25.2 Resolution Choices \u2014 Effects (Quick summary)", "Max Rounds": "4\u20136 turns (GM sets per mission).", "Naval Bombardment": "Coastal bombard applied from adjacent naval control or port; counts as tactical or strategic depending on target.\nPre-allocated Artillery Assets: Represented as campaign assets (e.g., Field Battery tokens) assigned to territories.\n26.2 Core Rules \u2014 Tactical Bombardment (pre-battle)\nR-26.2.1 Declaration: Bombardments must be declared in the Operations Phase before deployment. The declaring faction spends resources:\nField Artillery (local): 1 Industry (ammo) per pre-battle shot or 1 Momentum to call a limited barrage.\nAir Strike (requires Air Support unlocked): 1 Fuel + 1 Intel (precision) or 2 Fuel (area).\nNaval Bombardment (coastal only): 1 Industry + naval control token.\nR-26.2.2 Effects (apply before deployment):\nPre-battle Pin: Defender discards their first activation or loses one deployment asset.", "Negotiate": "Initiate diplomacy attempt (use Political Resolution mechanics); no XP; may lead to puppet/tribute/temporary ceasefire.\n25.3 Operational Strength & Approximation (OSV)\nWhen territory is revealed both sides present an Operational Strength Value (OSV) for rough comparison:\nOSV = sum(platoon_base_points \u00d7 Condition modifier) + General modifier + Fortification modifier + Supply modifier.\nGM provides only approximate OSV (round to nearest 50 or 100) when revealing to allow bluffing.\n25.4 Waiting Costs & Pressure", "Nonlethal Options": "Attacker may opt for covert capture instead of destruction; reputation gains/losses accordingly.\n23.8 Example (R-23.8.1 \u2014 Worked)", "Objective Types": "Demolition, Seize Documents, Assassinate/ kidnap, Defend Asset, Rescue POW, Destroy Battery, Recon & Exfiltrate.", "Opportunistic Captures": "a third faction may insert a small force to seize the opportunity (GM call).\n25.7 Pausing / Forcing Resolution\nAfter Turn 4 of contest, the GM may:\nForce a decisive resolution (adjudicate or require battle).\nAllow both sides to enter paused state where each must commit reinforcements or negotiate; paused battles require a pause-resume cost (1 Industry + 1 Manpower per side) to resume.\n25.8 Prolonged Engagements (multi-week)\nIf both sides insist, the territory enters Prolonged Engagement:\nWeekly Battle Rounds continue (max 4 per Campaign Turn, see main rulebook).\nReinforcements can be committed in Strategic Phase only if supply allows.\nAttrition increases by +1 Condition for both sides each weekly round without decisive breakthrough.\n25.9 Example (R-25.9)\nTwo factions meet at Tobruk. Both choose Hold/Recon first turn \u2014 defender prepares fortifications. Turn 2 attacker chooses Bombard (spending Industry + Fuel). Turn 3 attacker attacks; defender stands. After week 4 both sides still contest \u2014 Prolonged Engagement begins; GM applies exhaustion rules at the end of the Campaign Turn.\nTactical Missions\n23. SMALL-SCALE TACTICAL MISSIONS (Mid / Late Campaign)", "Political Cost": "Each strategic bombard has a 1-in-6 chance (roll D20 if high severity) to trigger a World Event (international condemnation, embargo, neutral intervention). If civilians are affected, Reputation \u22122.", "Primary Objective Success": "Complete objective within time limit.", "Probe/Recon": "Spend Intel (or roll recon) to reveal defender platoon conditions / hidden markers. Successful recon gives pre-battle advantage.", "Purpose": "Allow artillery, naval bombardment and air strikes to influence both tactical missions and contested territories meaningfully while tying costs and political risk to strategic bombardment.\n26.1 Definitions", "Purpose Statement": "Tactical missions are short, intense, objective-based tabletop games (or abstracted runs) that produce targeted strategic effects (intel, sabotage, POWs) rather than territory conquest.\n23.2 Mission Characteristics (Core)", "Recce Can Call Precision Strikes": "if recon detects exact emplacement and attacker spends 1 Intel, then Tactical Bombardment roll gains +3 modifier (precision).\n26.7 Political / Reputation Effects Summary\nTactical bombard (non-civilian): Reputation \u22120 to \u22121 if soldiers only.", "Rescue Pows": "Gain Prisoner Tokens (convertable to Manpower or Exchange).\n23.6 Withdrawal & Extraction Rules\nVoluntary Withdrawal (before engagement): No battlefield, but attacking platoon(s) suffer one Condition step and cannot refit next Strategic Phase. No XP.\nExtraction Under Fire (after partial success): Roll 1d6 per extracting platoon: on 1\u20132 losing heavy losses (extra Condition). Successful extraction yields full reward.", "Resolution Mechanic": "Roll 1d12 + Artillery Skill Modifier (GM or pre-set). Compare to threshold (8 recommended). On success apply full effect; on 6\u20137 apply half effect (pin only); on \u22645 wasted ammunition (no effect). If defender has air cover or good counterbattery, add \u22122 modifier to bombard roll.\n26.3 Strategic Bombardment (infrastructure)", "Resolve Choice Effects": "Apply immediate modifiers (bombard damage, recon reveals).", "Reveal": "When opposing platoons end movement in the same territory, the territory becomes CONTESTED and all side\u2019s presence is recorded (platoon types & approximate OSV; see R-25.3).\nDecision Window (Secret Order): Each side secretly writes one Resolution Choice (Attack, Hold, Withdraw, Probe/Recon, Bombard, Negotiate). Simultaneous reveal.", "Rewards": "Intel tokens, temporary research reveal, supply disruption, POW tokens, Momentum, Reputation modifiers. No permanent territory transfer unless mission is part of larger operation (GM determination).\n23.3 Mission Setup (Step-by-step)", "Scenario": "Attacker sends 1 platoon to sabotage a rail hub in Tripoli quarter tile. Time limit 4 rounds. Attacker spends 1 Intel to reveal defender anti-tank placement. On Round 3 the demolition team plants charges and must exfiltrate. Extraction succeeded (rolled 3/6 on 1d6 for extraction check), objective destroyed. Result: Attacker gains +2 Intel, -1 Industry to Tripoli for 1 turn, platoon +4 XP split, but each participating platoon suffers one Condition step due to firefight\nArmy\nPlatoon Types\nArtillery & Bombardment\n26. ARTILLERY, BOMBARDMENT & DEEP SUPPORT (Strategic and Tactical Layers)", "Secondary Objectives": "Optional targets (capture documents, take prisoner) that grant extra rewards.", "Select Mission Type": "Use GM table or player choice.", "Set Time Limit": "Default 4 rounds. GM may extend by paying costs (Industry or Momentum).\n23.4 Mission Resolution & Victory Conditions", "Stealth/Surprise": "If attacker spends Intel or recon successfully, they may start with a pre-game advantage (pre-placed pin or extra pre-battle position).\nFortification Micro-use: Defender\u2019s fortifications count at full effect; attacker may use demolition charges to reduce fortification effectiveness (spend Industry or specialist unit).", "Strategic Bombard With Civilian Deaths Or Heritage Site": "Reputation \u22122 and possible neutral intervention roll.\n26.8 Example (R-26.8 \u2014 Worked)", "Strategic Bombardment": "Campaign-level action targeting infrastructure (Factories, Ports, Supply Depots) across turns (costly + political risk).", "Tactical Bombard Causing Civilian Casualties": "Reputation \u22121 per incident.", "Tactical Bombardment": "Pre-battle bombard applied to a single tabletop game (cost moderate).", "Tactical Missions May Include Narrow Bombard Use": "e.g., 1 pre-battle bombard reduces one fortification or clears a lane. Cost is smaller (1 Industry). However, tactical bombard carries local civilian risk and possible intel leaks (if attacker bombs in proximity to research site, chance to reveal Tier II/III items).\n26.6 Recce & Special Ops Interaction", "Targets": "Factories, Rail Hubs, Ports, Supply Depots.", "Terrain Degradation": "Create area of soft ground: vehicle move halved first turn.", "Waiting Allows Recon To Gain Better Intel": "for each turn waited, a recon action yields +1 quality (reveal type \u2192 reveal condition \u2192 reveal research flags). But each recon increases chance of detection (enemy counterintelligence), creating a risk vs reward.\n25.6 Third-Party Intervention & Opportunism\nIf a territory remains contested for 2+ turns:\nNeighboring neutral or allied factions may intervene (roll D12 for chance based on adjacency and Reputation).", "Withdraw": "Retreat to adjacent friendly territory (subject to supply). Withdrawing units suffer -1 Condition.", "Withdrawal": "Allowed any time; withdrawal may impose penalties (see \u00a723.6).", "Worked Example": "Faction A spends 3 Industry + 2 Fuel to bomb Enemy Factory. Roll D20 (result 12) \u2192 moderate success \u2192 Factory output \u22121 Industry for 2 turns. Roll D20 chance-of-backlash (result 3) \u2192 minor diplomatic ripples (neutral trade route risks).\n26.4 Counterbattery & Air Defence", "AdjacencyList": []}}]}};
const LAYOUTS = {"theatre-we": {"viewBox": "0 0 1000 760", "shapes": {"WE-13": ["poly", "40,120 170,80 260,120 240,220 120,240 40,200"], "WE-01": ["rect", [280, 90, 130, 90]], "WE-02": ["rect", [430, 200, 150, 90]], "WE-03": ["rect", [470, 310, 160, 100]], "WE-04": ["rect", [640, 250, 120, 90]], "WE-05": ["rect", [770, 260, 140, 90]], "WE-06": ["rect", [820, 360, 140, 90]], "WE-07": ["rect", [770, 470, 170, 110]], "WE-14": ["rect", [650, 420, 110, 80]], "WE-08": ["rect", [620, 520, 120, 90]], "WE-09": ["rect", [610, 620, 130, 100]], "WE-10": ["rect", [360, 520, 190, 120]], "WE-11": ["rect", [520, 470, 110, 70]], "WE-12": ["rect", [650, 70, 210, 110]]}}, "theatre-ee": {"viewBox": "0 0 1000 700", "shapes": {"EE-01": ["rect", [120, 260, 150, 90]], "EE-02": ["rect", [280, 260, 150, 90]], "EE-03": ["rect", [440, 200, 150, 90]], "EE-04": ["rect", [440, 300, 150, 90]], "EE-05": ["rect", [600, 340, 150, 90]], "EE-06": ["rect", [760, 340, 170, 90]], "EE-07": ["rect", [820, 450, 150, 90]], "EE-10": ["rect", [600, 260, 150, 90]], "EE-08": ["rect", [760, 240, 170, 90]], "EE-09": ["rect", [760, 120, 170, 90]], "EE-11": ["rect", [600, 440, 150, 120]], "EE-12": ["rect", [760, 560, 170, 90]], "EE-13": ["rect", [120, 120, 220, 90]], "EE-14": ["rect", [360, 120, 220, 90]]}}, "theatre-na": {"viewBox": "0 0 1250 520", "shapes": {"NA-ALGCO": ["rect", [80, 130, 200, 90]], "NA-TNS": ["rect", [300, 130, 160, 90]], "NA-TRPL": ["rect", [480, 140, 160, 90]], "NA-BNGH": ["rect", [660, 150, 160, 90]], "NA-TBRK": ["rect", [840, 150, 160, 90]], "NA-ELAL": ["rect", [1060, 150, 150, 90]], "NA-TOBR": ["rect", [980, 260, 200, 90]], "NA-CORPS": ["rect", [980, 370, 200, 90]], "NA-ELAG": ["rect", [580, 260, 170, 90]], "NA-WDES": ["rect", [780, 260, 170, 90]], "NA-TBRG": ["rect", [820, 360, 170, 90]], "NA-SIOA": ["rect", [680, 360, 120, 90]], "NA-FEZ": ["rect", [420, 300, 150, 100]], "NA-SDES": ["rect", [560, 380, 200, 90]]}}, "theatre-pac": {"viewBox": "0 0 1100 650", "shapes": {"PA-AUSN": ["rect", [80, 520, 220, 110]], "PA-NEWG": ["rect", [330, 460, 200, 110]], "PA-SOLO": ["rect", [560, 480, 200, 90]], "PA-FIJI": ["rect", [820, 520, 200, 90]], "PA-PHIL": ["rect", [420, 280, 220, 110]], "PA-FORM": ["rect", [680, 240, 200, 110]], "PA-GUAM": ["rect", [740, 360, 160, 90]], "PA-MARI": ["rect", [560, 300, 160, 90]], "PA-CAROL": ["rect", [520, 410, 180, 90]], "PA-MARSH": ["rect", [820, 360, 220, 90]], "PA-GILB": ["rect", [860, 440, 200, 80]], "PA-MIDW": ["rect", [860, 160, 200, 80]], "PA-WAKE": ["rect", [640, 140, 180, 80]], "PA-SEA": ["poly", "170,80 350,40 560,70 770,60 980,90 1030,200 960,310 740,300 520,350 320,300 140,240 110,150"]}}};
const PALETTE = {"Neutral": "#9aa37a", "Allies": "#c2b280", "Axis": "#6e6e6e", "USSR": "#b13a3a", "USA": "#6b8f4e", "Japan": "#7a3b2e", "Italy": "#8b6f47", "Faction A": "#c2b280", "Faction B": "#6e6e6e", "Faction C": "#b13a3a", "Faction D": "#6b8f4e", "Faction E": "#7a3b2e", "Faction F": "#8b6f47"};
const SLOT_DEFAULTS = {"A": "Allies", "B": "Axis", "C": "USSR", "D": "USA", "E": "Japan", "F": "Italy"};

const STATES = {
  visibility: ["Unknown","Rumoured","Observed","Scouted","Owned"],
  supply: ["Supplied","Strained","Cut"],
  partisan: ["None","Low","High","Critical"],
  owners: ["Neutral","Allies","Axis","USSR","USA","Japan","Italy","Faction A","Faction B","Faction C","Faction D","Faction E","Faction F"]
};

const LS_KEY = "war_web_map_state_v1";

function loadState(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if(raw) return JSON.parse(raw);
  } catch(e) {}
  return {};
}
function saveState(st){ localStorage.setItem(LS_KEY, JSON.stringify(st)); }

function defaultTerrState(id){
  const vis = {};
  ["A","B","C","D","E","F"].forEach(s=>vis[s]="Unknown");
  return {
    owner: SLOT_DEFAULTS["A"] ? "Neutral" : "Neutral",
    supply: "Supplied",
    partisan: "Low",
    visibility: vis
  };
}
function ensureStateForTheatre(state, theatreId){
  const terrs = WAR_DATA[theatreId].territories;
  terrs.forEach(t=> {
    if(!state[t.id]) state[t.id] = defaultTerrState(t.id);
  });
  return state;
}

let appState = loadState();
let currentTheatre = "theatre-we";
let currentMode = "gm";
let currentFaction = "A";
let selectedTerr = null;
let showPins = true;

function ownerColor(owner){
  return PALETTE[owner] || "#b0b0b0";
}

function visibilityClass(v){
  return (v||"Unknown").toLowerCase();
}

function limitedInfo(territory, vis){
  // what player can see
  const base = {
    id: territory.id,
    name: territory.name,
    info: {}
  };
  const full = territory.info;
  if(vis === "Unknown") {
    base.name = "Unknown";
    return base;
  }
  if(vis === "Rumoured") {
    // Only show terrain and vague hook if available
    if(full.Terrain) base.info["Terrain"] = full.Terrain;
    return base;
  }
  if(vis === "Observed") {
    if(full.Terrain) base.info["Terrain"] = full.Terrain;
    if(full.Special) base.info["Special"] = full.Special;
    return base;
  }
  if(vis === "Scouted") {
    // Show most but not all
    Object.keys(full).forEach(k=> {
      if(k==="AdjacencyList") return;
      base.info[k] = full[k];
    });
    return base;
  }
  // Owned -> full
  Object.keys(full).forEach(k=> {
    if(k==="AdjacencyList") return;
    base.info[k] = full[k];
  });
  return base;
}

function buildSVG(theatreId){
  const layout = LAYOUTS[theatreId];
  const vb = layout.viewBox;
  const shapes = layout.shapes;

  // Backdrop per theatre (simple schematic coastline / graticule)
  const svgParts = [];
  svgParts.push(`<svg viewBox="${vb}" role="img" aria-label="${WAR_DATA[theatreId].name} map">`);
  // graticule
  for(let x=0;x<=1000;x+=100) svgParts.push(`<line class="graticule" x1="${x}" y1="0" x2="${x}" y2="800"/>`);
  for(let y=0;y<=800;y+=100) svgParts.push(`<line class="graticule" x1="0" y1="${y}" x2="1200" y2="${y}"/>`);

  // simple land/ocean patches (style only)
  svgParts.push(`<rect class="ocean" x="0" y="0" width="2000" height="2000"/>`);
  svgParts.push(`<path class="land" d="M 0 80 L 1200 60 L 1200 900 L 0 900 Z"/>`);

  // Territories
  const terrs = WAR_DATA[theatreId].territories;
  terrs.forEach(t=> {
    const st = appState[t.id] || defaultTerrState(t.id);
    const shape = shapes[t.id];
    if(!shape) return;
    const owner = st.owner;
    const fill = ownerColor(owner);
    const baseClass = "terr";
    let points = "";
    if(shape[0]==="poly") {
      points = shape[1];
    } else {
      const r = shape[1];
      points = "1,0 0,0 1,1 1,0 0,1 1,1 0,0 0,1"; // placeholder replaced below
    }
  });

  // We can't easily inject python-generated points in JS, so we render here in python style as strings
  svgParts.push(`<!-- TERRITORIES_START -->`);
  svgParts.push(`<!-- TERRITORIES_END -->`);

  // Pins (optional per theatre)
  svgParts.push(`<g id="pinsLayer"></g>`);

  svgParts.push(`</svg>`);
  return svgParts.join("\n");
}

function render(){
  appState = ensureStateForTheatre(appState, currentTheatre);
  saveState(appState);

  document.getElementById("mapTitle").textContent = WAR_DATA[currentTheatre].name;
  // Build SVG with territories injected (done outside buildSVG due to python points)
  const wrap = document.getElementById("mapWrap");
  wrap.innerHTML = window.__SVG_CACHE[currentTheatre];
  const svg = wrap.querySelector("svg");

  // Wire territory events
  svg.querySelectorAll(".terr").forEach(el=>{
    el.addEventListener("click", ()=> {
      const id = el.getAttribute("data-id");
      selectTerritory(id);
    });
  });

  // Pins toggle
  svg.querySelector("#pinsLayer").innerHTML = showPins ? window.__PINS_CACHE[currentTheatre] : "";

  // Apply classes based on mode + selected faction visibility
  applyTerritoryStyling();
  if(selectedTerr) updateInfoCard(selectedTerr);
}

function applyTerritoryStyling(){
  const svg = document.querySelector("#mapWrap svg");
  if(!svg) return;
  svg.querySelectorAll(".terr").forEach(el=> {
    const id = el.getAttribute("data-id");
    const st = appState[id] || defaultTerrState(id);
    // reset classes
    el.classList.remove("unknown","rumoured","observed","scouted","owned","selected","neighbor");
    if(currentMode==="player") {
      const vis = st.visibility[currentFaction] || "Unknown";
      el.classList.add(visibilityClass(vis));
    }
    if(selectedTerr && id===selectedTerr) el.classList.add("selected");
    // neighbor highlight
    if(selectedTerr) {
      const t = WAR_DATA[currentTheatre].territories.find(x=>x.id===selectedTerr);
      const adj = (t && t.info.AdjacencyList) ? t.info.AdjacencyList : [];
      if(adj.includes(id)) el.classList.add("neighbor");
    }
  });
}

function selectTerritory(id){
  selectedTerr = id;
  applyTerritoryStyling();
  updateInfoCard(id);
}

function makeSelect(options, value){
  return `<select>${options.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o}</option>`).join("")}</select>`;
}

function updateInfoCard(id){
  const terr = WAR_DATA[currentTheatre].territories.find(t=>t.id===id);
  if(!terr) return;
  const st = appState[id] || defaultTerrState(id);
  const owner = st.owner;
  const ownerDot = `<span class="dot" style="background:${ownerColor(owner)}"></span>`;

  const vis = st.visibility[currentFaction] || "Unknown";
  const view = (currentMode==="player") ? limitedInfo(terr, vis) : {
    id: terr.id, name: terr.name, info: Object.fromEntries(Object.entries(terr.info).filter(([k,_])=>k!=="AdjacencyList"))
  };

  // Build info table
  const rows = [];
  Object.keys(view.info).forEach(k=> {
    rows.push(`<tr><td class="k">${k}</td><td>${String(view.info[k]).replace(/\n/g,"<br/>")}</td></tr>`);
  });

  // adjacency links (always)
  const adj = terr.info.AdjacencyList || [];
  const adjLinks = adj.map(a=> `<a href="#" class="code" data-jump="${a}">${a}</a>`).join(", ") || "—";

  const badgeRow = `
    <div class="badges">
      <span class="badge">${ownerDot}<span><b>Owner</b>: ${owner}</span></span>
      <span class="badge"><span class="dot" style="background:#ddd"></span><span><b>Supply</b>: ${st.supply}</span></span>
      <span class="badge"><span class="dot" style="background:#ddd"></span><span><b>Partisans</b>: ${st.partisan}</span></span>
      <span class="badge"><span class="dot" style="background:#ddd"></span><span><b>${currentMode==="player" ? "Visibility" : "Your selected visibility"}</b>: ${vis}</span></span>
    </div>
  `;

  let gmEditor = "";
  if(currentMode==="gm") {
    gmEditor = `
      <fieldset>
        <legend>GM Edit (saved locally in your browser)</legend>
        <div class="row">
          <div>
            <label>Owner</label><br/>
            <select id="edOwner">${STATES.owners.map(o=>`<option value="${o}" ${o===st.owner?'selected':''}>${o}</option>`).join("")}</select>
          </div>
          <div>
            <label>Supply</label><br/>
            <select id="edSupply">${STATES.supply.map(o=>`<option value="${o}" ${o===st.supply?'selected':''}>${o}</option>`).join("")}</select>
          </div>
          <div>
            <label>Partisans</label><br/>
            <select id="edPart">${STATES.partisan.map(o=>`<option value="${o}" ${o===st.partisan?'selected':''}>${o}</option>`).join("")}</select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Visibility for Faction ${currentFaction}</label><br/>
            <select id="edVis">${STATES.visibility.map(o=>`<option value="${o}" ${o===(st.visibility[currentFaction]||"Unknown")?'selected':''}>${o}</option>`).join("")}</select>
          </div>
          <div>
            <label>&nbsp;</label><br/>
            <button id="btnSaveTerr">Save Territory</button>
          </div>
        </div>
        <div class="small" style="margin-top:8px">Tip: switch Player Faction to edit visibility per faction.</div>
      </fieldset>
    `;
  }

  document.getElementById("infoCard").innerHTML = `
    <div class="small code">${view.id}</div>
    <div style="font-family:var(--serif);font-size:22px;margin:2px 0 6px 0">${view.name}</div>
    ${badgeRow}
    <table class="kv">${rows.join("")}</table>
    <div class="small" style="margin-top:10px"><b>Adjacency:</b> ${adjLinks}</div>
    <hr/>
    ${gmEditor}
  `;

  // wire adjacency jumps
  document.querySelectorAll("[data-jump]").forEach(a=> {
    a.addEventListener("click",(e)=> {
      e.preventDefault();
      const target = a.getAttribute("data-jump");
      const el = document.querySelector(`.terr[data-id="${target}"]`);
      if(el) selectTerritory(target);
      else {
        // if in different theatre, try switch automatically
        const th = target.startsWith("WE-") ? "theatre-we"
                 : target.startsWith("EE-") ? "theatre-ee"
                 : target.startsWith("NA-") ? "theatre-na"
                 : target.startsWith("PA-") ? "theatre-pac"
                 : null;
        if(th && th!==currentTheatre) {
          currentTheatre = th;
          document.getElementById("theatreSel").value = th;
          selectedTerr = target;
          render();
        }
      }
    });
  });

  // wire save
  const btn = document.getElementById("btnSaveTerr");
  if(btn){
    btn.addEventListener("click", ()=> {
      const o = document.getElementById("edOwner").value;
      const s = document.getElementById("edSupply").value;
      const p = document.getElementById("edPart").value;
      const v = document.getElementById("edVis").value;
      if(!appState[id]) appState[id]=defaultTerrState(id);
      appState[id].owner=o;
      appState[id].supply=s;
      appState[id].partisan=p;
      appState[id].visibility[currentFaction]=v;
      saveState(appState);
      // update fill
      const terrEl = document.querySelector(`.terr[data-id="${id}"]`);
      if(terrEl) terrEl.setAttribute("fill", ownerColor(o));
      applyTerritoryStyling();
      updateInfoCard(id);
    });
  }
}

function buildTerritorySvgMarkup(theatreId){
  const shapes = LAYOUTS[theatreId].shapes;
  const terrs = WAR_DATA[theatreId].territories;
  const parts = [];
  terrs.forEach(t=> {
    const st = appState[t.id] || defaultTerrState(t.id);
    const owner = st.owner || "Neutral";
    const fill = ownerColor(owner);
    const shape = shapes[t.id];
    if(!shape) return;
    if(shape[0]==="poly") {
      parts.push(`<polygon class="terr" data-id="${t.id}" points="${shape[1]}" fill="${fill}"></polygon>`);
      // label at centroid-ish (rough)
      const pts = shape[1].trim().split(/\s+/).map(p=>p.split(",").map(Number));
      let cx=0,cy=0;
      pts.forEach(p=>{cx+=p[0];cy+=p[1];});
      cx/=pts.length; cy/=pts.length;
      parts.push(`<text class="id-label" x="${cx}" y="${cy}" text-anchor="middle">${t.id}</text>`);
    } else {
      const [x,y,w,h] = shape[1];
      // polygon with insets
      const i = Math.max(10, Math.min(w,h)*0.08);
      const pts = [
        [x+i,y],[x+w-i,y],[x+w,y+i],[x+w,y+h-i],[x+w-i,y+h],[x+i,y+h],[x,y+h-i],[x,y+i]
      ].map(p=>p.join(",")).join(" ");
      parts.push(`<polygon class="terr" data-id="${t.id}" points="${pts}" fill="${fill}"></polygon>`);
      parts.push(`<text class="id-label" x="${x+w/2}" y="${y+h/2}" text-anchor="middle">${t.id}</text>`);
    }
  });
  return parts.join("\n");
}

function buildPins(theatreId){
  // minimal "works best" approach: pins only for key hubs in each theatre (keeps clarity)
  const pins = [];
  if(theatreId==="theatre-we") {
    pins.push(pin(345,140,"London"));
    pins.push(pin(550,365,"Paris"));
    pins.push(pin(675,565,"Milan"));
    pins.push(pin(675,670,"Rome"));
    pins.push(pin(430,590,"Madrid"));
  } else if(theatreId==="theatre-ee") {
    pins.push(pin(200,300,"Warsaw"));
    pins.push(pin(845,285,"Moscow"));
    pins.push(pin(845,165,"Leningrad"));
    pins.push(pin(840,610,"Stalingrad"));
  } else if(theatreId==="theatre-na") {
    pins.push(pin(380,175,"Tunis"));
    pins.push(pin(560,190,"Tripoli"));
    pins.push(pin(735,195,"Benghazi"));
    pins.push(pin(910,195,"Tobruk"));
    pins.push(pin(1100,310,"Suez"));
    pins.push(pin(1100,420,"Cairo"));
  } else if(theatreId==="theatre-pac") {
    pins.push(pin(520,330,"Manila"));
    pins.push(pin(760,290,"Taipei"));
    pins.push(pin(205,565,"Darwin"));
  }
  return pins.join("\n");
}
function pin(x,y,label){
  return `<g>
    <circle class="pin" cx="${x}" cy="${y}" r="7"></circle>
    <text class="pin-label" x="${x+10}" y="${y+5}">${label}</text>
  </g>`;
}

function exportCSV(rows){
  const esc = (s)=> String(s).replace(/"/g,'""');
  return rows.map(r=>r.map(v=>`"${esc(v)}"`).join(",")).join("\n");
}
function download(filename, text){
  const blob = new Blob([text], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportTerritories(){
  const rows = [["TerritoryID","Theatre","Owner","Supply","Partisans","Vis_A","Vis_B","Vis_C","Vis_D","Vis_E","Vis_F"]];
  Object.keys(WAR_DATA).forEach(th=> {
    ensureStateForTheatre(appState, th);
    WAR_DATA[th].territories.forEach(t=> {
      const st = appState[t.id] || defaultTerrState(t.id);
      rows.push([
        t.id, WAR_DATA[th].name, st.owner, st.supply, st.partisan,
        st.visibility.A, st.visibility.B, st.visibility.C, st.visibility.D, st.visibility.E, st.visibility.F
      ]);
    });
  });
  download("Territories_Status.csv", exportCSV(rows));
}

function exportAdjacency(){
  const rows = [["Territory_A","Territory_B","ConnectionType"]];
  Object.keys(WAR_DATA).forEach(th=> {
    WAR_DATA[th].territories.forEach(t=> {
      const adj = t.info.AdjacencyList || [];
      adj.forEach(b=> {
        // naive connection type: sea if id ends with SEA or contains lanes, else land
        const a = t.id;
        const type = (a.includes("SEA") || b.includes("SEA") || a.includes("WE-13") || b.includes("WE-13")) ? "Sea" : "Land";
        // avoid duplicates
        if(a < b) rows.push([a,b,type]);
      });
    });
  });
  download("Adjacency.csv", exportCSV(rows));
}

// Precompute SVG caches with territory markup
window.__SVG_CACHE = {};
window.__PINS_CACHE = {};

function rebuildCaches(){
  Object.keys(WAR_DATA).forEach(th=> {
    appState = ensureStateForTheatre(appState, th);
    const layout = LAYOUTS[th];
    const vb = layout.viewBox;
    const terrMarkup = buildTerritorySvgMarkup(th);
    const base = `
<svg viewBox="${vb}" role="img" aria-label="${WAR_DATA[th].name} map">
  <rect class="ocean" x="-50" y="-50" width="2000" height="2000"></rect>
  <path class="land" d="M -50 60 L 1400 40 L 1400 1200 L -50 1200 Z"></path>
  <g opacity=".55">
    ${Array.from({length:20},(_,i)=>`<line class="graticule" x1="${i*80}" y1="-50" x2="${i*80}" y2="1200"/>`).join("")}
    ${Array.from({length:16},(_,i)=>`<line class="graticule" x1="-50" y1="${i*80}" x2="1400" y2="${i*80}"/>`).join("")}
  </g>
  <path class="coast" d="M 20 140 C 180 40, 360 120, 470 110 C 560 100, 630 60, 760 90 C 900 120, 980 80, 1120 120"></path>
  <g id="territoriesLayer">
    ${terrMarkup}
  </g>
  <g id="pinsLayer"></g>
</svg>`;
    window.__SVG_CACHE[th] = base;
    window.__PINS_CACHE[th] = buildPins(th);
  });
}

function init(){
  // controls
  document.getElementById("theatreSel").addEventListener("change",(e)=> {
    currentTheatre = e.target.value;
    selectedTerr = null;
    render();
  });
  document.getElementById("modeSel").addEventListener("change",(e)=> {
    currentMode = e.target.value;
    render();
  });
  document.getElementById("factionSel").addEventListener("change",(e)=> {
    currentFaction = e.target.value;
    applyTerritoryStyling();
    if(selectedTerr) updateInfoCard(selectedTerr);
  });
  document.getElementById("showPins").addEventListener("change",(e)=> {
    showPins = (e.target.value==="on");
    render();
  });
  document.getElementById("btnExportTerr").addEventListener("click", exportTerritories);
  document.getElementById("btnExportAdj").addEventListener("click", exportAdjacency);

  rebuildCaches();
  render();
}
init();
</script>
</body>
</html>
