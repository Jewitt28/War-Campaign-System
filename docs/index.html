<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WAR! Campaign — Strategic Board</title>

<style>
  :root{
    --bg:#2b2721;
    --paper:#3a342c;
    --ink:#e9e3d7;
    --line:#6b5b3e;
    --muted:#bdb6a8;

    --allies:#c9b27c;
    --axis:#666666;
    --ussr:#b22222;
    --neutral:#888888;
    --custom:#d9d9d9;

    --weTint: rgba(201,178,124,.10);
    --eeTint: rgba(178,34,34,.10);
    --naTint: rgba(224,176,122,.10);
    --paTint: rgba(122,160,224,.10);
  }

  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  #topbar{
    position:fixed; inset:0 0 auto 0; z-index:1000;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    padding:10px 12px; background:#1b1b1b; border-bottom:2px solid #444;
  }
  #topbar .title{font-weight:700; letter-spacing:1px; margin-right:auto;}
  #topbar button, #topbar select{
    background:#222; color:#eee; border:1px solid #555; padding:6px 10px; cursor:pointer;
  }
  #topbar button:hover{background:#333;}

  #wrap{
    position:absolute; top:60px; left:0; right:340px; bottom:0;
    overflow:auto;
    background:
      radial-gradient(circle at 20% 10%, rgba(255,255,255,.04), transparent 40%),
      radial-gradient(circle at 80% 30%, rgba(255,255,255,.03), transparent 45%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.035), rgba(255,255,255,.035) 24px, rgba(255,255,255,.02) 24px, rgba(255,255,255,.02) 48px);
  }
  #board{
    position:relative;
    width:1600px; height:1100px;
    margin:30px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.10)), var(--paper);
    border:3px solid var(--line);
    box-shadow:0 8px 30px rgba(0,0,0,.35);
  }

  .theatre{
    position:absolute; border:2px dashed rgba(233,227,215,.25);
    border-radius:10px; overflow:hidden;
  }
  .theatreHeader{
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px;
    border-bottom:1px solid rgba(233,227,215,.18);
    background:rgba(0,0,0,.25);
    font-weight:700; letter-spacing:2px; font-size:13px;
  }
  .theatreBody{position:relative; height:100%;}

  #WE{left:40px;  top:40px;  width:740px; height:480px; background:var(--weTint);}
  #EE{left:820px; top:40px;  width:740px; height:480px; background:var(--eeTint);}
  #NA{left:40px;  top:560px; width:740px; height:480px; background:var(--naTint);}
  #PA{left:820px; top:560px; width:740px; height:480px; background:var(--paTint);}

  /* Territory piece */
  .node{
    position:absolute;
    width:28px; height:28px;
    border-radius:50%;
    border:2px solid #000;
    display:flex; align-items:center; justify-content:center;
    font-size:14px;
    cursor:pointer;
    user-select:none;
    box-shadow:0 2px 8px rgba(0,0,0,.35);
  }

  .owner-allies{background:var(--allies); color:#111;}
  .owner-axis{background:var(--axis); color:#111;}
  .owner-ussr{background:var(--ussr); color:#111;}
  .owner-neutral{background:var(--neutral); color:#111;}
  .owner-custom{background:var(--custom); color:#111;}

  /* Fog: greyed but still visible */
  .fog-unknown{
    filter: grayscale(1);
    opacity: .35;
  }

  /* Right drawer */
  #panel{
    position:fixed; top:60px; right:0; bottom:0; width:340px;
    background:#171717; border-left:2px solid #444;
    padding:12px; overflow:auto; display:none;
  }
  #panel h2{margin:0 0 8px 0; font-size:16px;}
  .meta{color:var(--muted); font-size:12px; margin-bottom:10px;}
  .row{margin:10px 0;}
  .row label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px;}
  .row select, .row input, .row textarea{
    width:100%; background:#222; color:#eee; border:1px solid #555; padding:6px 8px;
    box-sizing:border-box;
  }
  .row textarea{min-height:70px; resize:vertical;}
  .pill{
    display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.15);
    border-radius:999px; font-size:12px; color:#ddd; background:rgba(0,0,0,.25);
    margin-right:6px;
  }
  .btnRow{display:flex; gap:10px; margin-top:10px;}
  .btnRow button{flex:1;}
  .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.4;}
</style>
</head>

<body>
  <div id="topbar">
    <div class="title">WAR! Campaign — Strategic Board (4 Theatres)</div>

    <label style="color:var(--muted);font-size:12px;">Mode</label>
    <select id="modeSel">
      <option value="GM">GM</option>
      <option value="PLAYER">Player</option>
    </select>

    <label style="color:var(--muted);font-size:12px;">Player Faction</label>
    <select id="playerFactionSel">
      <option value="allies">Allies</option>
      <option value="axis">Axis</option>
      <option value="ussr">USSR</option>
      <option value="custom">Custom</option>
    </select>

    <button onclick="jump('WE')">Western Europe</button>
    <button onclick="jump('EE')">Eastern Europe</button>
    <button onclick="jump('NA')">North Africa</button>
    <button onclick="jump('PA')">Pacific</button>

    <button onclick="exportState()">Export State</button>
    <button onclick="importState()">Import State</button>
    <button onclick="resetState()">Reset</button>
  </div>

  <div id="wrap">
    <div id="board">
      <div id="WE" class="theatre">
        <div class="theatreHeader"><span>WESTERN EUROPE</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="WE"></div>
      </div>

      <div id="EE" class="theatre">
        <div class="theatreHeader"><span>EASTERN EUROPE</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="EE"></div>
      </div>

      <div id="NA" class="theatre">
        <div class="theatreHeader"><span>NORTH AFRICA</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="NA"></div>
      </div>

      <div id="PA" class="theatre">
        <div class="theatreHeader"><span>PACIFIC</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="PA"></div>
      </div>
    </div>
  </div>

  <aside id="panel">
    <h2 id="pTitle"></h2>
    <div class="meta">
      <span class="pill" id="pTheatre"></span>
      <span class="pill" id="pId"></span>
    </div>

    <div id="playerInfo" class="row" style="display:none;">
      <div class="hint">
        Player view: details shown depend on visibility. Unknown territories stay visible but greyed.
      </div>
    </div>

    <div id="gmControls" style="display:none;">
      <div class="row">
        <label>Owner</label>
        <select id="ownerSel">
          <option value="neutral">Neutral</option>
          <option value="allies">Allies</option>
          <option value="axis">Axis</option>
          <option value="ussr">USSR</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div class="row">
        <label>Visibility (per faction)</label>
        <select id="visAllies">
          <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
        </select>
        <select id="visAxis" style="margin-top:6px;">
          <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
        </select>
        <select id="visUSSR" style="margin-top:6px;">
          <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
        </select>
        <select id="visCustom" style="margin-top:6px;">
          <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
        </select>
        <div class="hint">Order: Allies / Axis / USSR / Custom.</div>
      </div>

      <div class="row">
        <label>GM Notes</label>
        <textarea id="notes"></textarea>
      </div>

      <div class="btnRow">
        <button onclick="saveTerritory()">Save</button>
        <button onclick="closePanel()">Close</button>
      </div>
    </div>

    <div id="detailsBlock" class="row">
      <label>Details</label>
      <div id="detailsText" class="hint"></div>
    </div>

    <div class="hint" style="margin-top:14px;">
      Icons: ★ Allies, ✚ Axis, ☭ USSR, ⚑ Custom, ● Neutral
    </div>
  </aside>

<script>
/** Fixed positions (14 slots) used in every theatre panel */
const POS14 = [
  [140,120],[220,90],[320,100],[430,90],
  [120,200],[220,190],[330,200],[450,190],
  [140,280],[240,300],[340,290],[440,300],
  [200,370],[360,370]
];

const THEATRE_NAME = {WE:"Western Europe", EE:"Eastern Europe", NA:"North Africa", PA:"Pacific"};
const OWNER_ICON = {allies:"★", axis:"✚", ussr:"☭", neutral:"●", custom:"⚑"};
const STORAGE_KEY = "war_board_state_v1";

/** Territories (56) — IDs/names from your prototype JSON */
const TERRS = [
  // Western Europe (sorted by id)
  {id:"WE-01", name:"Southern England", theatreKey:"WE"},
  {id:"WE-02", name:"Northern England", theatreKey:"WE"},
  {id:"WE-03", name:"Normandy", theatreKey:"WE"},
  {id:"WE-04", name:"Paris Basin", theatreKey:"WE"},
  {id:"WE-05", name:"Low Countries", theatreKey:"WE"},
  {id:"WE-06", name:"Ruhr", theatreKey:"WE"},
  {id:"WE-07", name:"Western Germany", theatreKey:"WE"},
  {id:"WE-08", name:"Southern Germany", theatreKey:"WE"},
  {id:"WE-09", name:"Alpine Region", theatreKey:"WE"},
  {id:"WE-10", name:"Northern Italy", theatreKey:"WE"},
  {id:"WE-11", name:"Central Italy", theatreKey:"WE"},
  {id:"WE-12", name:"Iberian Peninsula", theatreKey:"WE"},
  {id:"WE-13", name:"Western Mediterranean Coast", theatreKey:"WE"},
  {id:"WE-14", name:"Atlantic Sea Lanes", theatreKey:"WE"},

  // Eastern Europe
  {id:"EE-01", name:"Western Poland", theatreKey:"EE"},
  {id:"EE-02", name:"Eastern Poland", theatreKey:"EE"},
  {id:"EE-03", name:"Baltic States", theatreKey:"EE"},
  {id:"EE-04", name:"Belarus", theatreKey:"EE"},
  {id:"EE-05", name:"Ukraine (West)", theatreKey:"EE"},
  {id:"EE-06", name:"Ukraine (East)", theatreKey:"EE"},
  {id:"EE-07", name:"Crimea", theatreKey:"EE"},
  {id:"EE-08", name:"Moscow", theatreKey:"EE"},
  {id:"EE-09", name:"Leningrad", theatreKey:"EE"},
  {id:"EE-10", name:"Smolensk Corridor", theatreKey:"EE"},
  {id:"EE-11", name:"Caucasus", theatreKey:"EE"},
  {id:"EE-12", name:"Stalingrad", theatreKey:"EE"},
  {id:"EE-13", name:"Arctic Front", theatreKey:"EE"},
  {id:"EE-14", name:"Volga Belt", theatreKey:"EE"},

  // North Africa
  {id:"NA-01", name:"Algeria Coast", theatreKey:"NA"},
  {id:"NA-02", name:"Tunis", theatreKey:"NA"},
  {id:"NA-03", name:"Tripoli", theatreKey:"NA"},
  {id:"NA-04", name:"Benghazi", theatreKey:"NA"},
  {id:"NA-05", name:"Tobruk", theatreKey:"NA"},
  {id:"NA-06", name:"El Alamein", theatreKey:"NA"},
  {id:"NA-07", name:"Alexandria", theatreKey:"NA"},
  {id:"NA-08", name:"Western Desert", theatreKey:"NA"},
  {id:"NA-09", name:"Southern Desert", theatreKey:"NA"},
  {id:"NA-10", name:"Fezzan", theatreKey:"NA"},
  {id:"NA-11", name:"Siwa Oasis", theatreKey:"NA"},
  {id:"NA-12", name:"Cairo Corridor", theatreKey:"NA"},
  {id:"NA-13", name:"Med Sea Lanes", theatreKey:"NA"},
  {id:"NA-14", name:"Red Sea Approaches", theatreKey:"NA"},

  // Pacific
  {id:"PA-01", name:"Midway", theatreKey:"PA"},
  {id:"PA-02", name:"Wake / Johnston", theatreKey:"PA"},
  {id:"PA-03", name:"Marshall Is.", theatreKey:"PA"},
  {id:"PA-04", name:"Gilbert Is.", theatreKey:"PA"},
  {id:"PA-05", name:"Caroline Is.", theatreKey:"PA"},
  {id:"PA-06", name:"Guam (sea lanes)", theatreKey:"PA"},
  {id:"PA-07", name:"Mariana Is.", theatreKey:"PA"},
  {id:"PA-08", name:"Philippines", theatreKey:"PA"},
  {id:"PA-09", name:"Solomon Is.", theatreKey:"PA"},
  {id:"PA-10", name:"New Guinea", theatreKey:"PA"},
  {id:"PA-11", name:"Fiji", theatreKey:"PA"},
  {id:"PA-12", name:"N. Australia", theatreKey:"PA"},
  {id:"PA-13", name:"Formosa", theatreKey:"PA"},
  {id:"PA-14", name:"Pacific Sea Lanes", theatreKey:"PA"},
];

/** State: owner + visibility + notes */
let state = loadState();
let currentId = null;

const modeSel = document.getElementById("modeSel");
const playerFactionSel = document.getElementById("playerFactionSel");

modeSel.addEventListener("change", () => {
  applyMode();
  rerenderFog();
});

playerFactionSel.addEventListener("change", () => rerenderFog());

function jump(key){
  document.getElementById(key).scrollIntoView({behavior:"smooth", block:"start", inline:"nearest"});
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  // default state
  const s = {};
  for(const t of TERRS){
    s[t.id] = {
      owner:"neutral",
      vis:{allies:"Known", axis:"Known", ussr:"Known", custom:"Known"},
      notes:""
    };
  }
  return s;
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function resetState(){
  if(!confirm("Reset all campaign state on this device?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = loadState();
  closePanel();
  renderAll();
}

function exportState(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "war_state.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importState(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = () => {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        state = parsed;
        saveState();
        closePanel();
        renderAll();
      }catch(e){
        alert("Invalid JSON.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function applyMode(){
  const mode = modeSel.value;
  document.getElementById("gmControls").style.display = (mode==="GM") ? "block" : "none";
  document.getElementById("playerInfo").style.display = (mode==="PLAYER") ? "block" : "none";
}

function nodeClassFor(owner){
  return `node owner-${owner}`;
}

function renderAll(){
  // clear theatre bodies
  document.querySelectorAll(".theatreBody").forEach(b => b.innerHTML = "");
  // group by theatre
  const byTheatre = {WE:[], EE:[], NA:[], PA:[]};
  for(const t of TERRS) byTheatre[t.theatreKey].push(t);

  for(const key of Object.keys(byTheatre)){
    const body = document.querySelector(`.theatreBody[data-theatre="${key}"]`);
    const list = byTheatre[key];

    // stable order by id
    list.sort((a,b)=> a.id.localeCompare(b.id));

    list.forEach((t, idx) => {
      const [x,y] = POS14[idx];
      const st = state[t.id] || {owner:"neutral", vis:{allies:"Known",axis:"Known",ussr:"Known",custom:"Known"}, notes:""};
      const el = document.createElement("div");
      el.className = nodeClassFor(st.owner);
      el.style.left = x + "px";
      el.style.top = y + "px";
      el.textContent = OWNER_ICON[st.owner] || "●";
      el.dataset.id = t.id;
      el.dataset.theatre = key;
      el.title = `${t.id} — ${t.name}`;
      el.addEventListener("click", () => openPanel(t.id));
      body.appendChild(el);
    });
  }

  applyMode();
  rerenderFog();
}

function rerenderFog(){
  const mode = modeSel.value;
  const faction = playerFactionSel.value;
  document.querySelectorAll(".node").forEach(el => {
    const tid = el.dataset.id;
    const st = state[tid];
    el.classList.remove("fog-unknown");
    if(mode === "PLAYER"){
      const v = (st && st.vis && st.vis[faction]) ? st.vis[faction] : "Unknown";
      if(v === "Unknown") el.classList.add("fog-unknown");
    }
  });

  // If a panel is open, refresh it too
  if(currentId) refreshPanel(currentId);
}

function openPanel(id){
  currentId = id;
  refreshPanel(id);
  document.getElementById("panel").style.display = "block";
}

function closePanel(){
  currentId = null;
  document.getElementById("panel").style.display = "none";
}

function refreshPanel(id){
  const t = TERRS.find(x => x.id === id);
  if(!t) return;
  const st = state[id];

  document.getElementById("pTitle").textContent = t.name;
  document.getElementById("pTheatre").textContent = THEATRE_NAME[t.theatreKey];
  document.getElementById("pId").textContent = t.id;

  const mode = modeSel.value;
  const pf = playerFactionSel.value;

  // Details block: show less in PLAYER mode if Unknown
  const vis = st.vis[pf] || "Unknown";
  const details = [];
  details.push(`Visibility for ${pf.toUpperCase()}: ${vis}`);
  if(mode === "GM" || vis !== "Unknown"){
    details.push(`Owner: ${st.owner.toUpperCase()}`);
    if(st.notes) details.push(`Notes: ${st.notes}`);
  } else {
    details.push("Details hidden.");
  }
  document.getElementById("detailsText").textContent = details.join(" • ");

  // GM controls
  if(mode === "GM"){
    document.getElementById("ownerSel").value = st.owner;
    document.getElementById("visAllies").value = st.vis.allies || "Known";
    document.getElementById("visAxis").value = st.vis.axis || "Known";
    document.getElementById("visUSSR").value = st.vis.ussr || "Known";
    document.getElementById("visCustom").value = st.vis.custom || "Known";
    document.getElementById("notes").value = st.notes || "";
  }
}

function saveTerritory(){
  if(!currentId) return;
  const st = state[currentId];
  st.owner = document.getElementById("ownerSel").value;
  st.vis = {
    allies: document.getElementById("visAllies").value,
    axis: document.getElementById("visAxis").value,
    ussr: document.getElementById("visUSSR").value,
    custom: document.getElementById("visCustom").value
  };
  st.notes = document.getElementById("notes").value || "";
  saveState();

  // update node appearance
  const node = document.querySelector(`.node[data-id="${currentId}"]`);
  if(node){
    node.className = nodeClassFor(st.owner);
    node.textContent = OWNER_ICON[st.owner] || "●";
  }
  rerenderFog();
}

renderAll();
</script>
</body>
</html>