import { useEffect, useMemo, useRef, useState } from "react";

type TheatreData = {
  schemaVersion: string;
  theatres: Array<{
    theatreId: string;
    title: string;
    territories: Array<{
      id: string; // e.g. "WE-01"
      name: string;
      shapeRefs: string[]; // e.g. ["United_Kingdom_UK_1", ...]
    }>;
  }>;
};

type TerritoryInfo = {
  id: string;
  name: string;
  theatreId: string;
  theatreTitle: string;
  shapeRefs: string[];
};

type Selection = {
  territoryId: string;
  territoryName: string;
  theatreId: string;
  theatreTitle: string;
  clickedShapeId: string;
};

export default function MapBoard() {
  const svgHostRef = useRef<HTMLDivElement>(null);

  const [data, setData] = useState<TheatreData | null>(null);
  const [selected, setSelected] = useState<Selection | null>(null);

  // ----- Build maps from theatres_all.json -----
  const { allowedShapeIds, shapeToTerritory } = useMemo(() => {
    const allowed = new Set<string>();
    const map = new Map<string, TerritoryInfo>();

    if (data) {
      for (const th of data.theatres) {
        for (const t of th.territories) {
          const info: TerritoryInfo = {
            id: t.id,
            name: t.name,
            theatreId: th.theatreId,
            theatreTitle: th.title,
            shapeRefs: t.shapeRefs ?? [],
          };

          for (const shapeId of info.shapeRefs) {
            allowed.add(shapeId);
            map.set(shapeId, info);
          }
        }
      }
    }

    return { allowedShapeIds: allowed, shapeToTerritory: map };
  }, [data]);

  // ----- Styling helpers -----
  function clearSelectionStyles(svg: SVGSVGElement) {
    svg.querySelectorAll<SVGPathElement>("path").forEach((p) => {
      p.style.opacity = "0.35";
      p.style.stroke = "#111";
      p.style.strokeWidth = "0.6";
      p.style.cursor = "default";
      p.style.pointerEvents = "none";
    });
  }

  function enableTerritoryShapes(svg: SVGSVGElement) {
    // disable everything first
    clearSelectionStyles(svg);

    // enable only your allowed shapes
    allowedShapeIds.forEach((id) => {
      const p = svg.querySelector<SVGPathElement>(`#${CSS.escape(id)}`);
      if (!p) return;

      p.style.opacity = "0.9";
      p.style.cursor = "pointer";
      p.style.pointerEvents = "auto";
      // keep borders visible
      p.style.stroke = "#1a1a1a";
      p.style.strokeWidth = "0.8";
    });
  }

  function highlightTerritory(svg: SVGSVGElement, territory: TerritoryInfo) {
    // dim all enabled shapes
    allowedShapeIds.forEach((id) => {
      const p = svg.querySelector<SVGPathElement>(`#${CSS.escape(id)}`);
      if (!p) return;
      p.style.opacity = "0.35";
      p.style.stroke = "#222";
      p.style.strokeWidth = "0.8";
    });

    // highlight all shapes belonging to the selected territory
    territory.shapeRefs.forEach((id) => {
      const p = svg.querySelector<SVGPathElement>(`#${CSS.escape(id)}`);
      if (!p) return;
      p.style.opacity = "1";
      p.style.stroke = "#ffffff";
      p.style.strokeWidth = "2";
    });
  }

  function wireTerritoryClicks(svg: SVGSVGElement) {
    // Attach handler only to allowed shapes
    allowedShapeIds.forEach((shapeId) => {
      const path = svg.querySelector<SVGPathElement>(`#${CSS.escape(shapeId)}`);
      if (!path) return;

      path.addEventListener("click", (e) => {
        e.stopPropagation();

        const territory = shapeToTerritory.get(shapeId);
        if (!territory) return;

        setSelected({
          territoryId: territory.id,
          territoryName: territory.name,
          theatreId: territory.theatreId,
          theatreTitle: territory.theatreTitle,
          clickedShapeId: shapeId,
        });

        highlightTerritory(svg, territory);
      });
    });

    // Optional: click empty space clears highlight
    svg.addEventListener("click", () => {
      setSelected(null);
      enableTerritoryShapes(svg);
    });
  }

  // ----- Load theatres_all.json once -----
  useEffect(() => {
    // Put theatres_all.json in /public for Vite (recommended)
    fetch("/theatres_all.json")
      .then((r) => r.json())
      .then((j: TheatreData) => setData(j))
      .catch((err) => console.error("Failed to load theatres_all.json", err));
  }, []);

  // ----- Load SVG after data is available (because we need allowedShapeIds) -----
  useEffect(() => {
    if (!data) return;

    fetch("/mapchart_world.svg")
      .then((r) => r.text())
      .then((svgText) => {
        if (!svgHostRef.current) return;

        svgHostRef.current.innerHTML = svgText;

        const svg = svgHostRef.current.querySelector("svg");
        if (!svg) return;

        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");
        svg.style.display = "block";

        enableTerritoryShapes(svg);
        wireTerritoryClicks(svg);
      })
      .catch((err) => console.error("Failed to load SVG", err));
  }, [data, allowedShapeIds, shapeToTerritory]);

  return (
    <div style={{ display: "flex", height: "100%" }}>
      <div
        ref={svgHostRef}
        style={{
          flex: 1,
          background: "#3a372f",
          overflow: "hidden",
        }}
      />

      <div
        style={{
          width: 320,
          padding: 12,
          borderLeft: "1px solid #555",
          background: "#2b2923",
          color: "#eee",
          fontSize: 14,
        }}
      >
        <h3 style={{ marginTop: 0 }}>Selection</h3>

        {!data && <div>Loading theatresâ€¦</div>}

        {selected ? (
          <div style={{ lineHeight: 1.5 }}>
            <div>
              <strong>Territory:</strong> {selected.territoryName} ({selected.territoryId})
            </div>
            <div>
              <strong>Theatre:</strong> {selected.theatreTitle} ({selected.theatreId})
            </div>
            <div style={{ opacity: 0.8, marginTop: 8 }}>
              <strong>Clicked shape:</strong> {selected.clickedShapeId}
            </div>
          </div>
        ) : (
          <div>Click a territory (only your campaign territories are clickable)</div>
        )}
      </div>
    </div>
  );
}
