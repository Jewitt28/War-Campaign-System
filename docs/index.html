<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WAR! Campaign — Strategic Board</title>

<style>
  :root{
    --bg:#2b2721;
    --paper:#3a342c;
    --ink:#e9e3d7;
    --line:#6b5b3e;
    --muted:#bdb6a8;

    --allies:#c9b27c;
    --axis:#666666;
    --ussr:#b22222;
    --neutral:#888888;
    --custom:#d9d9d9;

    --weTint: rgba(201,178,124,.10);
    --eeTint: rgba(178,34,34,.10);
    --naTint: rgba(224,176,122,.10);
    --paTint: rgba(122,160,224,.10);
  }

  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  #topbar{
    position:fixed; inset:0 0 auto 0; z-index:1000;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    padding:10px 12px; background:#1b1b1b; border-bottom:2px solid #444;
  }
  #topbar .title{font-weight:700; letter-spacing:1px; margin-right:auto;}
  #topbar button, #topbar select{
    background:#222; color:#eee; border:1px solid #555; padding:6px 10px; cursor:pointer;
  }
  #topbar button:hover{background:#333;}
  #topbar .smallLabel{color:var(--muted);font-size:12px;}

  #wrap{
    position:absolute; top:64px; left:0; right:430px; bottom:0;
    overflow:auto;
    background:
      radial-gradient(circle at 20% 10%, rgba(255,255,255,.04), transparent 40%),
      radial-gradient(circle at 80% 30%, rgba(255,255,255,.03), transparent 45%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.035), rgba(255,255,255,.035) 24px, rgba(255,255,255,.02) 24px, rgba(255,255,255,.02) 48px);
  }
  #board{
    position:relative;
    width:1600px; height:1100px;
    margin:30px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.10)), var(--paper);
    border:3px solid var(--line);
    box-shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* Edges overlay */
  #edges{
    position:absolute; inset:0;
    z-index:2;
    pointer-events:none;
  }
  .edgeLine{ stroke: rgba(233,227,215,.25); stroke-width: 2; }
  .edgeLine.dim{ stroke: rgba(233,227,215,.12); }
  .edgeLine.strong{ stroke: rgba(233,227,215,.55); stroke-width: 3; }

  .theatre{
    position:absolute; z-index:1;
    border:2px dashed rgba(233,227,215,.25);
    border-radius:10px; overflow:hidden;
  }
  .theatreHeader{
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px;
    border-bottom:1px solid rgba(233,227,215,.18);
    background:rgba(0,0,0,.25);
    font-weight:700; letter-spacing:2px; font-size:13px;
  }
  .theatreBody{position:relative; height:100%;}

  #WE{left:40px;  top:40px;  width:740px; height:480px; background:var(--weTint);}
  #EE{left:820px; top:40px;  width:740px; height:480px; background:var(--eeTint);}
  #NA{left:40px;  top:560px; width:740px; height:480px; background:var(--naTint);}
  #PA{left:820px; top:560px; width:740px; height:480px; background:var(--paTint);}

  /* Territory piece */
  .node{
    position:absolute;
    width:28px; height:28px;
    border-radius:50%;
    border:2px solid #000;
    display:flex; align-items:center; justify-content:center;
    font-size:14px;
    cursor:pointer;
    user-select:none;
    box-shadow:0 2px 8px rgba(0,0,0,.35);
    z-index:3;
    transition: transform .08s ease, box-shadow .08s ease, outline-color .08s ease;
  }
  .node:hover{ transform: translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.45); }

  .owner-allies{background:var(--allies); color:#111;}
  .owner-axis{background:var(--axis); color:#111;}
  .owner-ussr{background:var(--ussr); color:#111;}
  .owner-neutral{background:var(--neutral); color:#111;}
  .owner-custom{background:var(--custom); color:#111;}

  /* Fog: greyed but still visible */
  .fog-unknown{ filter: grayscale(1); opacity: .35; }

  /* Selection */
  .selected{ outline: 3px solid rgba(233,227,215,.70); outline-offset: 2px; }
  .adjacent{ outline: 3px solid rgba(233,227,215,.35); outline-offset: 2px; }

  /* Right drawer */
  #panel{
    position:fixed; top:64px; right:0; bottom:0; width:430px;
    background:#171717; border-left:2px solid #444;
    padding:12px; overflow:auto; display:none;
  }
  #panel h2{margin:0 0 8px 0; font-size:16px;}
  .meta{color:var(--muted); font-size:12px; margin-bottom:10px;}
  .row{margin:10px 0;}
  .row label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px;}
  .row select, .row textarea, .row input{
    width:100%; background:#222; color:#eee; border:1px solid #555; padding:6px 8px;
    box-sizing:border-box;
  }
  .row textarea{min-height:70px; resize:vertical;}
  .pill{
    display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.15);
    border-radius:999px; font-size:12px; color:#ddd; background:rgba(0,0,0,.25);
    margin-right:6px;
  }
  .btnRow{display:flex; gap:10px; margin-top:10px;}
  .btnRow button{flex:1;}
  .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.4;}
  .linkish{ color:#e9e3d7; text-decoration:underline; cursor:pointer; }
  .linkish:hover{ opacity:.85; }

  .grid2{
    display:grid;
    grid-template-columns: 90px 1fr;
    gap:6px 8px;
    align-items:center;
  }
  .grid2 .tag{ font-size:12px; color:var(--muted); }

  .hr{height:1px;background:rgba(255,255,255,.08); margin:14px 0;}

  .orderCard{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    padding:8px;
    border-radius:10px;
    margin-top:8px;
  }
  .orderTop{
    display:flex; justify-content:space-between; gap:8px; align-items:center;
    font-size:12px; color:var(--muted);
  }
  .orderMain{ margin-top:6px; font-size:13px; }
  .orderBtns{ display:flex; gap:8px; margin-top:8px; }
  .orderBtns button{ flex:1; }
</style>
</head>

<body>
  <div id="topbar">
    <div class="title">WAR! Campaign — Strategic Board</div>

    <span class="pill" id="turnPill">Turn 1</span>
    <span class="pill" id="phasePill">Strategic</span>

    <span class="smallLabel">Phase</span>
    <select id="phaseSel">
      <option value="Strategic">Strategic</option>
      <option value="Operations">Operations</option>
      <option value="Resolution">Resolution</option>
    </select>

    <button id="advanceBtn">Advance Phase</button>

    <span class="smallLabel">Auto-advance turn</span>
    <select id="autoAdvSel">
      <option value="on" selected>On</option>
      <option value="off">Off</option>
    </select>

    <span class="smallLabel">Mode</span>
    <select id="modeSel">
      <option value="GM">GM</option>
      <option value="PLAYER">Player</option>
    </select>

    <span class="smallLabel">Player Faction</span>
    <select id="playerFactionSel">
      <option value="allies">Allies</option>
      <option value="axis">Axis</option>
      <option value="ussr">USSR</option>
      <option value="custom">Custom</option>
    </select>

    <span class="smallLabel">Adjacency</span>
    <select id="adjSel">
      <option value="off">Off</option>
      <option value="select" selected>On Select</option>
      <option value="always">Always</option>
    </select>

    <button onclick="jump('WE')">W. Europe</button>
    <button onclick="jump('EE')">E. Europe</button>
    <button onclick="jump('NA')">N. Africa</button>
    <button onclick="jump('PA')">Pacific</button>

    <button onclick="exportState()">Export</button>
    <button onclick="importState()">Import</button>
    <button onclick="resetState()">Reset</button>
  </div>

  <div id="wrap">
    <div id="board">
      <svg id="edges"></svg>

      <div id="WE" class="theatre">
        <div class="theatreHeader"><span>WESTERN EUROPE</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="WE"></div>
      </div>

      <div id="EE" class="theatre">
        <div class="theatreHeader"><span>EASTERN EUROPE</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="EE"></div>
      </div>

      <div id="NA" class="theatre">
        <div class="theatreHeader"><span>NORTH AFRICA</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="NA"></div>
      </div>

      <div id="PA" class="theatre">
        <div class="theatreHeader"><span>PACIFIC</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="PA"></div>
      </div>
    </div>
  </div>

  <aside id="panel">
    <h2 id="pTitle"></h2>
    <div class="meta">
      <span class="pill" id="pTheatre"></span>
      <span class="pill" id="pId"></span>
    </div>

    <!-- Faction HQ quick view -->
    <div class="row">
      <label>Faction HQ (Quick)</label>
      <div class="hint" id="hqQuick"></div>
      <div class="btnRow" id="hqBtns" style="display:none;">
        <button onclick="gmAdjustResources(+1)">+1 Res</button>
        <button onclick="gmAdjustResources(-1)">-1 Res</button>
      </div>
      <div class="hint" style="margin-top:8px;">
        Resource collection happens automatically at start of Strategic: +1 per controlled territory (simple baseline).
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label>Adjacency</label>
      <div id="adjList" class="hint"></div>
      <div class="hint">Tip: click a neighbour to jump/highlight.</div>
    </div>

    <div class="hr"></div>

    <!-- Movement Helper -->
    <div class="row">
      <label>Movement Helper</label>
      <div class="hint">
        <div><span class="pill">From</span> <span id="mvFrom">—</span></div>
        <div style="margin-top:6px;"><span class="pill">To</span> <span id="mvTo">—</span></div>
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <button onclick="setMoveFromCurrent()">Set as Origin</button>
        <button onclick="trySetMoveToCurrent()">Set as Destination</button>
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <button onclick="logMove()">Log Move</button>
        <button onclick="clearMove()">Clear</button>
      </div>
      <div id="mvHint" class="hint"></div>
      <div id="mvOptions" class="hint" style="margin-top:10px;"></div>
    </div>

    <div class="hr"></div>

    <!-- Orders -->
    <div class="row">
      <label>Orders (Operations Phase)</label>
      <div class="hint" id="ordersHint"></div>

      <div class="row">
        <label>General Name</label>
        <input id="orderGeneral" placeholder="e.g. Gen. Montgomery" />
      </div>

      <div class="row">
        <label>Order Type</label>
        <select id="orderType">
          <option value="Move">Move</option>
          <option value="Attack">Attack</option>
          <option value="Recon">Recon</option>
          <option value="Withdraw">Withdraw</option>
          <option value="Bombard">Bombard</option>
          <option value="Hold">Hold</option>
        </select>
      </div>

      <div class="row">
        <label>From (use current territory or pick)</label>
        <select id="orderFrom"></select>
      </div>

      <div class="row">
        <label>To (optional; for Move/Attack/Recon/Bombard/Withdraw)</label>
        <select id="orderTo"></select>
        <div class="hint" style="margin-top:8px;">Move/Attack/etc must be adjacent. Hold ignores To.</div>
      </div>

      <div class="row">
        <label>Condition (optional; 1 binary condition max)</label>
        <input id="orderCond" placeholder='e.g. "If enemy present, Withdraw; else Move"' />
      </div>

      <div class="row">
        <label>Notes</label>
        <input id="orderNotes" placeholder="Any extra detail for GM." />
      </div>

      <div class="btnRow">
        <button onclick="createOrder()">Add Order</button>
        <button onclick="closePanel()">Close</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        Player orders are hidden from other factions until Resolution. After Ops ends, orders lock.
      </div>

      <div id="ordersList"></div>
    </div>

    <div class="hr"></div>

    <div id="playerInfo" class="row" style="display:none;">
      <div class="hint">Player view: Unknown territories stay visible but greyed.</div>
    </div>

    <div id="gmControls" style="display:none;">
      <div class="row">
        <label>Owner</label>
        <select id="ownerSel">
          <option value="neutral">Neutral</option>
          <option value="allies">Allies</option>
          <option value="axis">Axis</option>
          <option value="ussr">USSR</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div class="row">
        <label>Visibility (per faction)</label>
        <div class="grid2">
          <div class="tag">Allies</div>
          <select id="visAllies"><option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option></select>
          <div class="tag">Axis</div>
          <select id="visAxis"><option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option></select>
          <div class="tag">USSR</div>
          <select id="visUSSR"><option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option></select>
          <div class="tag">Custom</div>
          <select id="visCustom"><option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option></select>
        </div>
      </div>

      <div class="row">
        <label>GM Notes</label>
        <textarea id="notes"></textarea>
      </div>

      <div class="btnRow">
        <button onclick="saveTerritory()">Save Territory</button>
        <button onclick="closePanel()">Close</button>
      </div>
    </div>

    <div class="hint" style="margin-top:14px;">
      Icons: ★ Allies, ✚ Axis, ☭ USSR, ⚑ Custom, ● Neutral
    </div>
  </aside>

<script>
/** Fixed positions (14 slots) used in every theatre panel */
const POS14 = [
  [140,120],[220,90],[320,100],[430,90],
  [120,200],[220,190],[330,200],[450,190],
  [140,280],[240,300],[340,290],[440,300],
  [200,370],[360,370]
];

const THEATRE_NAME = {WE:"Western Europe", EE:"Eastern Europe", NA:"North Africa", PA:"Pacific"};
const OWNER_ICON = {allies:"★", axis:"✚", ussr:"☭", neutral:"●", custom:"⚑"};
const STORAGE_KEY = "war_board_state_v3";

/** Territories with adjacency (from your prototype extraction) */
const TERRS = [{"id":"EE-01","name":"Western Poland","theatreKey":"EE","adj":["EE-02"]},{"id":"EE-02","name":"Eastern Poland","theatreKey":"EE","adj":["EE-01","EE-03"]},{"id":"EE-03","name":"Baltic States","theatreKey":"EE","adj":["EE-02","EE-04"]},{"id":"EE-04","name":"Belarus","theatreKey":"EE","adj":["EE-03","EE-05"]},{"id":"EE-05","name":"Ukraine (West)","theatreKey":"EE","adj":["EE-04","EE-06"]},{"id":"EE-06","name":"Ukraine (East)","theatreKey":"EE","adj":["EE-05","EE-07","EE-11"]},{"id":"EE-07","name":"Crimea","theatreKey":"EE","adj":["EE-06","EE-08"]},{"id":"EE-08","name":"Moscow","theatreKey":"EE","adj":["EE-07","EE-09"]},{"id":"EE-09","name":"Leningrad","theatreKey":"EE","adj":["EE-08","EE-10"]},{"id":"EE-10","name":"Smolensk Corridor","theatreKey":"EE","adj":["EE-09","EE-11"]},{"id":"EE-11","name":"Caucasus","theatreKey":"EE","adj":["EE-10","EE-12","EE-06"]},{"id":"EE-12","name":"Stalingrad","theatreKey":"EE","adj":["EE-11","EE-13"]},{"id":"EE-13","name":"Arctic Front","theatreKey":"EE","adj":["EE-12","EE-14"]},{"id":"EE-14","name":"Volga Belt","theatreKey":"EE","adj":["EE-13"]},{"id":"NA-01","name":"Algeria Coast","theatreKey":"NA","adj":["NA-02"]},{"id":"NA-02","name":"Tunis","theatreKey":"NA","adj":["NA-01","NA-03"]},{"id":"NA-03","name":"Tripoli","theatreKey":"NA","adj":["NA-02","NA-04"]},{"id":"NA-04","name":"Benghazi","theatreKey":"NA","adj":["NA-03","NA-05"]},{"id":"NA-05","name":"Tobruk","theatreKey":"NA","adj":["NA-04","NA-06"]},{"id":"NA-06","name":"El Alamein","theatreKey":"NA","adj":["NA-05","NA-07"]},{"id":"NA-07","name":"Alexandria","theatreKey":"NA","adj":["NA-06","NA-08"]},{"id":"NA-08","name":"Western Desert","theatreKey":"NA","adj":["NA-07","NA-09"]},{"id":"NA-09","name":"Southern Desert","theatreKey":"NA","adj":["NA-08","NA-10"]},{"id":"NA-10","name":"Fezzan","theatreKey":"NA","adj":["NA-09","NA-11"]},{"id":"NA-11","name":"Siwa Oasis","theatreKey":"NA","adj":["NA-10","NA-12"]},{"id":"NA-12","name":"Cairo Corridor","theatreKey":"NA","adj":["NA-11","NA-13"]},{"id":"NA-13","name":"Med Sea Lanes","theatreKey":"NA","adj":["NA-12","NA-14"]},{"id":"NA-14","name":"Red Sea Approaches","theatreKey":"NA","adj":["NA-13"]},{"id":"PA-01","name":"Midway","theatreKey":"PA","adj":["PA-02"]},{"id":"PA-02","name":"Wake / Johnston","theatreKey":"PA","adj":["PA-01","PA-03"]},{"id":"PA-03","name":"Marshall Is.","theatreKey":"PA","adj":["PA-02","PA-04"]},{"id":"PA-04","name":"Gilbert Is.","theatreKey":"PA","adj":["PA-03","PA-05"]},{"id":"PA-05","name":"Caroline Is.","theatreKey":"PA","adj":["PA-04","PA-06"]},{"id":"PA-06","name":"Guam (sea lanes)","theatreKey":"PA","adj":["PA-05","PA-07"]},{"id":"PA-07","name":"Mariana Is.","theatreKey":"PA","adj":["PA-06","PA-08"]},{"id":"PA-08","name":"Philippines","theatreKey":"PA","adj":["PA-07","PA-09","PA-13"]},{"id":"PA-09","name":"Solomon Is.","theatreKey":"PA","adj":["PA-08","PA-10"]},{"id":"PA-10","name":"New Guinea","theatreKey":"PA","adj":["PA-09","PA-11"]},{"id":"PA-11","name":"Fiji","theatreKey":"PA","adj":["PA-10","PA-12"]},{"id":"PA-12","name":"N. Australia","theatreKey":"PA","adj":["PA-11","PA-14"]},{"id":"PA-13","name":"Formosa","theatreKey":"PA","adj":["PA-08"]},{"id":"PA-14","name":"Pacific Sea Lanes","theatreKey":"PA","adj":["PA-12"]},{"id":"WE-01","name":"Southern England","theatreKey":"WE","adj":["WE-02"]},{"id":"WE-02","name":"Northern France","theatreKey":"WE","adj":["WE-01","WE-03"]},{"id":"WE-03","name":"Benelux","theatreKey":"WE","adj":["WE-02","WE-04"]},{"id":"WE-04","name":"Western Germany","theatreKey":"WE","adj":["WE-03","WE-05"]},{"id":"WE-05","name":"Berlin Region","theatreKey":"WE","adj":["WE-04","WE-06"]},{"id":"WE-06","name":"Denmark / Norway Sea Lane","theatreKey":"WE","adj":["WE-05","WE-07"]},{"id":"WE-07","name":"Northern Italy","theatreKey":"WE","adj":["WE-06","WE-08"]},{"id":"WE-08","name":"Central Italy","theatreKey":"WE","adj":["WE-07","WE-09"]},{"id":"WE-09","name":"Southern Italy","theatreKey":"WE","adj":["WE-08","WE-10"]},{"id":"WE-10","name":"Iberian Peninsula","theatreKey":"WE","adj":["WE-09","WE-11"]},{"id":"WE-11","name":"Western Mediterranean Coast","theatreKey":"WE","adj":["WE-10","WE-12"]},{"id":"WE-12","name":"Scandinavia (South)","theatreKey":"WE","adj":["WE-11","WE-13"]},{"id":"WE-13","name":"Atlantic Sea Lanes","theatreKey":"WE","adj":["WE-12","WE-14"]},{"id":"WE-14","name":"Alpine Region","theatreKey":"WE","adj":["WE-13"]}];

const byId = new Map(TERRS.map(t => [t.id, t]));

const board = document.getElementById("board");
const edgesSvg = document.getElementById("edges");

const modeSel = document.getElementById("modeSel");
const playerFactionSel = document.getElementById("playerFactionSel");
const adjSel = document.getElementById("adjSel");

const phaseSel = document.getElementById("phaseSel");
const advanceBtn = document.getElementById("advanceBtn");
const autoAdvSel = document.getElementById("autoAdvSel");

const turnPill = document.getElementById("turnPill");
const phasePill = document.getElementById("phasePill");

let state = loadState();
let currentId = null;

/* Movement helper state */
let moveFrom = null;
let moveTo = null;

modeSel.addEventListener("change", () => {
  applyMode();
  rerenderFog();
  redrawEdges();
  refreshMoveUI();
  refreshHQQuick();
  refreshOrdersUI();
  refreshPhaseUI();
});

playerFactionSel.addEventListener("change", () => {
  rerenderFog();
  redrawEdges();
  refreshMoveUI();
  refreshHQQuick();
  refreshOrdersUI();
});

adjSel.addEventListener("change", () => redrawEdges());

phaseSel.addEventListener("change", () => {
  // Players can't change phase
  if(modeSel.value !== "GM"){
    refreshPhaseUI();
    return;
  }
  setPhase(phaseSel.value, {manual:true});
});

autoAdvSel.addEventListener("change", () => {
  state._meta.autoAdvanceTurn = (autoAdvSel.value === "on");
  saveState();
});

advanceBtn.addEventListener("click", () => {
  if(modeSel.value !== "GM") return;
  advancePhase();
});

function jump(key){
  document.getElementById(key).scrollIntoView({behavior:"smooth", block:"start", inline:"nearest"});
}

function defaultMeta(){
  return {
    turn: 1,
    phase: "Strategic",
    autoAdvanceTurn: true,
    moveLog: [],
    orders: {},   // orders[turn][faction] = []
    factions: {
      allies:{resources:0},
      axis:{resources:0},
      ussr:{resources:0},
      custom:{resources:0}
    }
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      // Territory backfill
      for(const t of TERRS){
        if(!parsed[t.id]) parsed[t.id] = {};
        parsed[t.id].owner = parsed[t.id].owner || "neutral";
        parsed[t.id].vis = parsed[t.id].vis || {allies:"Known", axis:"Known", ussr:"Known", custom:"Known"};
        parsed[t.id].notes = parsed[t.id].notes || "";
      }
      // Meta backfill
      parsed._meta = parsed._meta || defaultMeta();
      parsed._meta.turn = typeof parsed._meta.turn === "number" ? parsed._meta.turn : 1;
      parsed._meta.phase = parsed._meta.phase || "Strategic";
      parsed._meta.autoAdvanceTurn = (parsed._meta.autoAdvanceTurn !== false);
      parsed._meta.moveLog = Array.isArray(parsed._meta.moveLog) ? parsed._meta.moveLog : [];
      parsed._meta.orders = parsed._meta.orders || {};
      parsed._meta.factions = parsed._meta.factions || defaultMeta().factions;
      for(const f of ["allies","axis","ussr","custom"]){
        if(!parsed._meta.factions[f]) parsed._meta.factions[f] = {resources:0};
        if(typeof parsed._meta.factions[f].resources !== "number") parsed._meta.factions[f].resources = 0;
      }
      return parsed;
    }
  }catch(e){}
  const s = {};
  for(const t of TERRS){
    s[t.id] = {
      owner:"neutral",
      vis:{allies:"Known", axis:"Known", ussr:"Known", custom:"Known"},
      notes:""
    };
  }
  s._meta = defaultMeta();
  return s;
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function resetState(){
  if(!confirm("Reset all campaign state on this device?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = loadState();
  closePanel();
  clearMove();
  renderAll();
}

function exportState(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "war_state.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importState(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = () => {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        const fresh = loadState();
        for(const k of Object.keys(parsed)) fresh[k] = parsed[k];
        state = fresh;
        saveState();
        closePanel();
        renderAll();
      }catch(e){
        alert("Invalid JSON.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

/* -------------------------
   Turn + Phase
-------------------------- */
function refreshPhaseUI(){
  const m = state._meta;
  turnPill.textContent = `Turn ${m.turn}`;
  phasePill.textContent = m.phase;
  phaseSel.value = m.phase;
  autoAdvSel.value = m.autoAdvanceTurn ? "on" : "off";

  // Only GM can change phase selector
  phaseSel.disabled = (modeSel.value !== "GM");
  advanceBtn.disabled = (modeSel.value !== "GM");

  // If Ops ended, lock orders (safety)
  if(m.phase !== "Operations"){
    lockOrdersForTurn(m.turn);
  }
}

function setPhase(newPhase, {manual=false}={}){
  const old = state._meta.phase;
  state._meta.phase = newPhase;

  // Auto resource collection at START of Strategic
  if(old !== "Strategic" && newPhase === "Strategic"){
    autoCollectResources();
  }

  // Lock orders when leaving Operations
  if(old === "Operations" && newPhase !== "Operations"){
    lockOrdersForTurn(state._meta.turn);
  }

  saveState();
  refreshPhaseUI();
  refreshOrdersUI();
  rerenderFog();
  redrawEdges();
}

function advancePhase(){
  const p = state._meta.phase;
  if(p === "Strategic") setPhase("Operations", {manual:true});
  else if(p === "Operations") setPhase("Resolution", {manual:true});
  else {
    // Resolution -> Strategic (next turn if auto)
    if(state._meta.autoAdvanceTurn){
      state._meta.turn += 1;
    }
    setPhase("Strategic", {manual:true});
  }
}

function lockOrdersForTurn(turn){
  const bucket = (state._meta.orders && state._meta.orders[turn]) ? state._meta.orders[turn] : null;
  if(!bucket) return;
  for(const f of Object.keys(bucket)){
    for(const o of bucket[f]){
      o.status = "locked";
    }
  }
  saveState();
}

/* Simple baseline: +1 resource per controlled territory */
function autoCollectResources(){
  const counts = {allies:0, axis:0, ussr:0, custom:0};
  for(const t of TERRS){
    const owner = state[t.id].owner;
    if(counts[owner] !== undefined) counts[owner] += 1;
  }
  for(const f of ["allies","axis","ussr","custom"]){
    state._meta.factions[f].resources += counts[f];
  }
  saveState();
}

/* GM quick adjust (panel faction = either playerFaction in player mode, or current selector in GM) */
function gmAdjustResources(delta){
  if(modeSel.value !== "GM") return;
  const f = playerFactionSel.value;
  state._meta.factions[f].resources = Math.max(0, state._meta.factions[f].resources + delta);
  saveState();
  refreshHQQuick();
}

/* -------------------------
   Ownership + Fog
-------------------------- */
function applyMode(){
  const mode = modeSel.value;
  document.getElementById("gmControls").style.display = (mode==="GM") ? "block" : "none";
  document.getElementById("playerInfo").style.display = (mode==="PLAYER") ? "block" : "none";
  document.getElementById("hqBtns").style.display = (mode==="GM") ? "flex" : "none";
}

function nodeClassFor(owner){ return `node owner-${owner}`; }

function rerenderFog(){
  const mode = modeSel.value;
  const faction = playerFactionSel.value;
  document.querySelectorAll(".node").forEach(el => {
    const tid = el.dataset.id;
    const st = state[tid];
    el.classList.remove("fog-unknown");
    if(mode === "PLAYER"){
      const v = (st && st.vis && st.vis[faction]) ? st.vis[faction] : "Unknown";
      if(v === "Unknown") el.classList.add("fog-unknown");
    }
  });
  if(currentId) refreshPanel(currentId);
}

/* -------------------------
   Render Map
-------------------------- */
function renderAll(){
  document.querySelectorAll(".theatreBody").forEach(b => b.innerHTML = "");
  clearEdges();
  clearHighlights();
  populateOrderDropdowns();

  const byTheatre = {WE:[], EE:[], NA:[], PA:[]};
  for(const t of TERRS) byTheatre[t.theatreKey].push(t);

  for(const key of Object.keys(byTheatre)){
    const body = document.querySelector(`.theatreBody[data-theatre="${key}"]`);
    const list = byTheatre[key];
    list.sort((a,b)=> a.id.localeCompare(b.id));

    list.forEach((t, idx) => {
      const [x,y] = POS14[idx];
      const st = state[t.id];
      const el = document.createElement("div");
      el.className = nodeClassFor(st.owner);
      el.style.left = x + "px";
      el.style.top = y + "px";
      el.textContent = OWNER_ICON[st.owner] || "●";
      el.dataset.id = t.id;
      el.dataset.theatre = key;
      el.title = `${t.id} — ${t.name}`;
      el.addEventListener("click", () => openPanel(t.id));
      body.appendChild(el);
    });
  }

  applyMode();
  refreshPhaseUI();
  rerenderFog();
  redrawEdges();
  refreshHQQuick();
  refreshMoveUI();
  refreshOrdersUI();
}

function clearHighlights(){
  document.querySelectorAll(".node").forEach(n => {
    n.classList.remove("selected");
    n.classList.remove("adjacent");
  });
}

/* --- Adjacency edges --- */
function clearEdges(){
  while(edgesSvg.firstChild) edgesSvg.removeChild(edgesSvg.firstChild);
}
function nodeCenter(id){
  const el = document.querySelector(`.node[data-id="${id}"]`);
  if(!el) return null;
  const b = board.getBoundingClientRect();
  const r = el.getBoundingClientRect();
  return { x:(r.left-b.left)+r.width/2, y:(r.top-b.top)+r.height/2 };
}
function drawLine(aId, bId, cls){
  const a = nodeCenter(aId), b = nodeCenter(bId);
  if(!a || !b) return;
  const line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1", a.x); line.setAttribute("y1", a.y);
  line.setAttribute("x2", b.x); line.setAttribute("y2", b.y);
  line.setAttribute("class", cls);
  edgesSvg.appendChild(line);
}
function redrawEdges(){
  edgesSvg.setAttribute("width", board.clientWidth);
  edgesSvg.setAttribute("height", board.clientHeight);
  edgesSvg.setAttribute("viewBox", `0 0 ${board.clientWidth} ${board.clientHeight}`);

  const mode = adjSel.value;
  clearEdges();
  if(mode === "off") return;

  if(mode === "always"){
    const seen = new Set();
    for(const t of TERRS){
      for(const n of t.adj){
        const key = [t.id, n].sort().join("|");
        if(seen.has(key)) continue;
        seen.add(key);
        drawLine(t.id, n, "edgeLine");
      }
    }
    return;
  }
  if(currentId) highlightAdjacency(currentId);
}
function highlightAdjacency(id){
  clearEdges();
  clearHighlights();
  const t = byId.get(id);
  if(!t) return;

  const selectedEl = document.querySelector(`.node[data-id="${id}"]`);
  if(selectedEl) selectedEl.classList.add("selected");

  const mode = modeSel.value;
  const faction = playerFactionSel.value;

  for(const n of t.adj){
    const nEl = document.querySelector(`.node[data-id="${n}"]`);
    if(nEl) nEl.classList.add("adjacent");

    let cls = "edgeLine strong";
    if(mode === "PLAYER"){
      const st = state[n];
      const vis = (st && st.vis && st.vis[faction]) ? st.vis[faction] : "Unknown";
      if(vis === "Unknown") cls = "edgeLine dim";
    }
    drawLine(id, n, cls);
  }
}

/* -------------------------
   Panel
-------------------------- */
function openPanel(id){
  currentId = id;
  refreshPanel(id);
  document.getElementById("panel").style.display = "block";

  // Prefill order FROM to selected territory
  document.getElementById("orderFrom").value = id;

  if(adjSel.value === "select") highlightAdjacency(id);
  else{
    clearHighlights();
    const el = document.querySelector(`.node[data-id="${id}"]`);
    if(el) el.classList.add("selected");
  }

  refreshHQQuick();
  refreshMoveUI();
  refreshOrdersUI();
}

function closePanel(){
  currentId = null;
  document.getElementById("panel").style.display = "none";
  clearHighlights();
  redrawEdges();
}

function refreshPanel(id){
  const t = byId.get(id);
  if(!t) return;
  const st = state[id];

  document.getElementById("pTitle").textContent = t.name;
  document.getElementById("pTheatre").textContent = THEATRE_NAME[t.theatreKey];
  document.getElementById("pId").textContent = t.id;

  // adjacency list
  const adjList = document.getElementById("adjList");
  if(!t.adj || !t.adj.length) adjList.textContent = "None";
  else{
    adjList.innerHTML = "";
    t.adj.forEach((nid, i) => {
      const nt = byId.get(nid);
      const span = document.createElement("span");
      span.className = "linkish";
      span.textContent = nt ? `${nid} — ${nt.name}` : nid;
      span.onclick = () => {
        jump(nt.theatreKey);
        setTimeout(() => openPanel(nid), 250);
      };
      adjList.appendChild(span);
      if(i < t.adj.length-1) adjList.appendChild(document.createTextNode(" • "));
    });
  }

  // GM fields
  if(modeSel.value === "GM"){
    document.getElementById("ownerSel").value = st.owner;
    document.getElementById("visAllies").value = st.vis.allies || "Known";
    document.getElementById("visAxis").value = st.vis.axis || "Known";
    document.getElementById("visUSSR").value = st.vis.ussr || "Known";
    document.getElementById("visCustom").value = st.vis.custom || "Known";
    document.getElementById("notes").value = st.notes || "";
  }
}

function saveTerritory(){
  if(!currentId) return;
  const st = state[currentId];
  st.owner = document.getElementById("ownerSel").value;
  st.vis = {
    allies: document.getElementById("visAllies").value,
    axis: document.getElementById("visAxis").value,
    ussr: document.getElementById("visUSSR").value,
    custom: document.getElementById("visCustom").value
  };
  st.notes = document.getElementById("notes").value || "";
  saveState();

  const node = document.querySelector(`.node[data-id="${currentId}"]`);
  if(node){
    node.className = nodeClassFor(st.owner);
    node.textContent = OWNER_ICON[st.owner] || "●";
  }
  rerenderFog();
  redrawEdges();
  refreshHQQuick();
}

/* -------------------------
   HQ Quick
-------------------------- */
function refreshHQQuick(){
  const f = playerFactionSel.value;
  const res = state._meta.factions[f].resources;

  let ctrl = 0;
  for(const t of TERRS){
    if(state[t.id].owner === f) ctrl++;
  }

  const phase = state._meta.phase;
  const turn = state._meta.turn;
  const who = (modeSel.value === "GM") ? "GM view" : "Player view";

  document.getElementById("hqQuick").innerHTML =
    `Faction: <b>${f.toUpperCase()}</b> • Resources: <b>${res}</b> • Controlled: <b>${ctrl}</b><br>` +
    `Turn: <b>${turn}</b> • Phase: <b>${phase}</b> • ${who}`;
}

/* -------------------------
   Movement Helper
-------------------------- */
function setMoveFromCurrent(){
  if(!currentId) return;
  moveFrom = currentId;
  if(moveTo && !isAdjacent(moveFrom, moveTo)) moveTo = null;
  refreshMoveUI();
  if(adjSel.value === "select") highlightAdjacency(moveFrom);
}
function trySetMoveToCurrent(){
  if(!currentId) return;
  if(!moveFrom){ setMoveFromCurrent(); return; }
  if(currentId === moveFrom){ moveTo = null; refreshMoveUI(); return; }
  if(isAdjacent(moveFrom, currentId)){
    moveTo = currentId;
    setMoveHint("");
  } else {
    setMoveHint(`Not adjacent: ${moveFrom} → ${currentId}. Choose a highlighted neighbour.`);
    moveTo = null;
  }
  refreshMoveUI();
}
function isAdjacent(a, b){
  const ta = byId.get(a);
  return ta && (ta.adj || []).includes(b);
}
function clearMove(){
  moveFrom = null; moveTo = null;
  setMoveHint("");
  refreshMoveUI();
}
function setMoveHint(msg){ document.getElementById("mvHint").textContent = msg || ""; }

function refreshMoveUI(){
  const fromT = moveFrom ? byId.get(moveFrom) : null;
  const toT = moveTo ? byId.get(moveTo) : null;

  document.getElementById("mvFrom").textContent = fromT ? `${moveFrom} — ${fromT.name}` : "—";
  document.getElementById("mvTo").textContent = toT ? `${moveTo} — ${toT.name}` : "—";

  const optionsEl = document.getElementById("mvOptions");
  optionsEl.innerHTML = "";

  if(moveFrom){
    const ta = byId.get(moveFrom);
    const title = document.createElement("div");
    title.className = "hint";
    title.textContent = "Valid destinations:";
    optionsEl.appendChild(title);

    const list = document.createElement("div");
    (ta.adj || []).forEach((nid, i) => {
      const nt = byId.get(nid);
      const span = document.createElement("span");
      span.className = "linkish";
      span.textContent = `${nid} — ${nt.name}`;
      span.onclick = () => {
        moveTo = nid;
        jump(nt.theatreKey);
        setTimeout(() => openPanel(nid), 250);
        refreshMoveUI();
      };
      list.appendChild(span);
      if(i < ta.adj.length-1) list.appendChild(document.createTextNode(" • "));
    });
    optionsEl.appendChild(list);

    if(moveTo && !isAdjacent(moveFrom, moveTo)){
      moveTo = null;
      setMoveHint("Destination cleared (not adjacent).");
    }
  } else {
    optionsEl.textContent = "Set an origin to see valid destinations.";
  }
}

function logMove(){
  if(!moveFrom || !moveTo){ setMoveHint("Set both Origin and Destination first."); return; }
  if(!isAdjacent(moveFrom, moveTo)){ setMoveHint("Invalid move (not adjacent)."); return; }

  if(modeSel.value !== "GM"){
    setMoveHint("Player mode: move planned (not logged). Switch to GM to log.");
    return;
  }

  const entry = { turn: state._meta.turn, from: moveFrom, to: moveTo, ts: new Date().toISOString() };
  state._meta.moveLog.push(entry);
  saveState();
  setMoveHint(`Logged: Turn ${entry.turn} — ${entry.from} → ${entry.to}`);
}

/* -------------------------
   Orders System
-------------------------- */
function getOrdersBucket(turn){
  if(!state._meta.orders) state._meta.orders = {};
  if(!state._meta.orders[turn]){
    state._meta.orders[turn] = {allies:[], axis:[], ussr:[], custom:[]};
  } else {
    // backfill factions
    for(const f of ["allies","axis","ussr","custom"]){
      if(!state._meta.orders[turn][f]) state._meta.orders[turn][f] = [];
    }
  }
  return state._meta.orders[turn];
}

function populateOrderDropdowns(){
  const fromSel = document.getElementById("orderFrom");
  const toSel = document.getElementById("orderTo");
  const ids = TERRS.map(t => t.id).sort();

  fromSel.innerHTML = "";
  toSel.innerHTML = "";

  for(const id of ids){
    const t = byId.get(id);
    const opt1 = document.createElement("option");
    opt1.value = id;
    opt1.textContent = `${id} — ${t.name}`;
    fromSel.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = id;
    opt2.textContent = `${id} — ${t.name}`;
    toSel.appendChild(opt2);
  }
}

function refreshOrdersUI(){
  const turn = state._meta.turn;
  const phase = state._meta.phase;
  const mode = modeSel.value;
  const pf = playerFactionSel.value;

  const hint = document.getElementById("ordersHint");
  const canSubmit = (phase === "Operations");
  if(phase !== "Operations"){
    hint.textContent = `Current phase is ${phase}. Orders are submitted in Operations. In Resolution, orders are revealed.`;
  } else {
    hint.textContent = `Operations Phase: submit secret orders. Orders lock when Ops ends.`;
  }

  // Disable add order UI if not Ops and not GM
  const disableInputs = (!canSubmit && mode !== "GM");
  for(const id of ["orderGeneral","orderType","orderFrom","orderTo","orderCond","orderNotes"]){
    document.getElementById(id).disabled = disableInputs;
  }

  renderOrdersList();
}

function createOrder(){
  const turn = state._meta.turn;
  const phase = state._meta.phase;
  const mode = modeSel.value;
  const pf = playerFactionSel.value;

  if(phase !== "Operations" && mode !== "GM"){
    alert("Orders can only be added in Operations Phase (unless GM).");
    return;
  }

  const general = document.getElementById("orderGeneral").value.trim() || "Unnamed General";
  const type = document.getElementById("orderType").value;
  const from = document.getElementById("orderFrom").value;
  const to = document.getElementById("orderTo").value;
  const cond = document.getElementById("orderCond").value.trim();
  const notes = document.getElementById("orderNotes").value.trim();

  // adjacency validation for relevant types
  const needsTo = !["Hold"].includes(type);
  if(needsTo){
    if(!isAdjacent(from, to)){
      alert(`Invalid: ${type} requires an adjacent target. ${from} → ${to} is not adjacent.`);
      return;
    }
  }

  // binary condition best-effort: just warn if looks like multiple conditions
  const bad = /(\bif\b.*\bif\b)|(\bunless\b.*\bunless\b)/i.test(cond);
  if(cond && bad){
    if(!confirm("Condition looks complex (multiple conditions). Keep it anyway?")) return;
  }

  const bucket = getOrdersBucket(turn);
  const order = {
    id: cryptoId(),
    turn,
    faction: pf,
    general,
    type,
    from,
    to: needsTo ? to : null,
    condition: cond || null,
    notes: notes || null,
    status: (phase === "Operations") ? "draft" : "locked",
    submittedAt: new Date().toISOString()
  };
  bucket[pf].push(order);
  saveState();
  renderOrdersList();
}

function canViewOrder(o){
  const mode = modeSel.value;
  const pf = playerFactionSel.value;
  const phase = state._meta.phase;

  if(mode === "GM") return true;

  // Player sees own faction orders always (even in Operations)
  if(o.faction === pf) return true;

  // Enemy orders visible only in Resolution (and later)
  if(phase === "Resolution") return true;

  return false;
}

function canEditOrder(o){
  const mode = modeSel.value;
  const pf = playerFactionSel.value;
  const phase = state._meta.phase;

  if(mode === "GM") return true;
  if(o.faction !== pf) return false;
  if(phase !== "Operations") return false;
  if(o.status !== "draft") return false;
  return true;
}

function renderOrdersList(){
  const list = document.getElementById("ordersList");
  list.innerHTML = "";

  const turn = state._meta.turn;
  const bucket = getOrdersBucket(turn);

  // Collect orders in display order
  const all = [];
  for(const f of ["allies","axis","ussr","custom"]){
    for(const o of bucket[f]) all.push(o);
  }
  // newest first
  all.sort((a,b) => (b.submittedAt||"").localeCompare(a.submittedAt||""));

  if(all.length === 0){
    const empty = document.createElement("div");
    empty.className = "hint";
    empty.textContent = "No orders yet for this turn.";
    list.appendChild(empty);
    return;
  }

  for(const o of all){
    if(!canViewOrder(o)) continue;

    const card = document.createElement("div");
    card.className = "orderCard";

    const top = document.createElement("div");
    top.className = "orderTop";
    top.innerHTML = `<span>${o.faction.toUpperCase()} • ${o.general}</span><span>${o.status || "draft"}</span>`;
    card.appendChild(top);

    const main = document.createElement("div");
    main.className = "orderMain";
    const toTxt = o.to ? ` → <b>${o.to}</b>` : "";
    const condTxt = o.condition ? `<br><span class="pill">IF</span> ${escapeHtml(o.condition)}` : "";
    const notesTxt = o.notes ? `<br><span class="pill">NOTE</span> ${escapeHtml(o.notes)}` : "";
    main.innerHTML =
      `<b>${o.type}</b> from <b>${o.from}</b>${toTxt}` + condTxt + notesTxt;
    card.appendChild(main);

    const btns = document.createElement("div");
    btns.className = "orderBtns";

    const jumpBtn = document.createElement("button");
    jumpBtn.textContent = "Go To";
    jumpBtn.onclick = () => {
      const t = byId.get(o.from);
      jump(t.theatreKey);
      setTimeout(()=>openPanel(o.from), 250);
    };
    btns.appendChild(jumpBtn);

    if(canEditOrder(o)){
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.onclick = () => deleteOrder(o.id);
      btns.appendChild(delBtn);
    } else {
      const ghost = document.createElement("button");
      ghost.textContent = "Locked";
      ghost.disabled = true;
      btns.appendChild(ghost);
    }

    card.appendChild(btns);
    list.appendChild(card);
  }
}

function deleteOrder(orderId){
  const turn = state._meta.turn;
  const bucket = getOrdersBucket(turn);
  for(const f of ["allies","axis","ussr","custom"]){
    const idx = bucket[f].findIndex(o => o.id === orderId);
    if(idx >= 0){
      if(!canEditOrder(bucket[f][idx])) return;
      bucket[f].splice(idx,1);
      saveState();
      renderOrdersList();
      return;
    }
  }
}

function cryptoId(){
  try{
    return crypto.randomUUID();
  }catch(e){
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now();
  }
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* -------------------------
   Init
-------------------------- */
applyMode();
populateOrderDropdowns();
renderAll();
window.addEventListener("resize", () => redrawEdges());
</script>
  <script type="module">
  async function loadTheatres() {
    const res = await fetch('./assets/data/theatres_all.json', { cache: 'no-store' });
    if (!res.ok) throw new Error(`Failed to load theatre data: ${res.status}`);
    return await res.json();
  }

  function byId(arr) {
    return Object.fromEntries(arr.map(x => [x.id, x]));
  }

  function renderUI(data) {
    const theatres = data.theatres;
    const theatreSelect = document.getElementById('theatreSelect');
    const territoryList = document.getElementById('territoryList');
    const territoryDetail = document.getElementById('territoryDetail');

    theatres.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.theatreId;
      opt.textContent = `${t.theatreId} — ${t.title || t.theatreId}`;
      theatreSelect.appendChild(opt);
    });

    function showTheatre(theatreId) {
      const theatre = theatres.find(t => t.theatreId === theatreId);
      const territories = theatre.territories;
      const tById = byId(territories);

      territoryList.innerHTML = '';
      territories.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `${t.id} — ${t.name}`;
        li.style.cursor = 'pointer';
        li.onclick = () => showTerritory(theatre, t);
        territoryList.appendChild(li);
      });

      function showTerritory(theatre, terr) {
        const adj = theatre.adjacency?.[terr.id] || { land: [], sea: [] };
        territoryDetail.innerHTML = `
          <h3>${terr.id} — ${terr.name}</h3>
          <p><b>Land:</b> ${(adj.land || []).join(', ') || '—'}</p>
          <p><b>Sea:</b> ${(adj.sea || []).join(', ') || '—'}</p>
          <p><b>Shape refs:</b> ${(terr.shapeRefs || []).slice(0, 6).join(', ')}${(terr.shapeRefs||[]).length > 6 ? '…' : ''}</p>
        `;
      }

      // default select first territory
      if (territories[0]) showTerritory(theatre, territories[0]);
    }

    theatreSelect.onchange = () => showTheatre(theatreSelect.value);
    showTheatre(theatres[0].theatreId);
  }

  // bootstrap
  (async () => {
    const data = await loadTheatres();
    renderUI(data);
  })();
</script>

</body>
</html>
