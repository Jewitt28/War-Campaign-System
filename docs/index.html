<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WAR! Campaign — Strategic Board</title>

<style>
  :root{
    --bg:#2b2721;
    --paper:#3a342c;
    --ink:#e9e3d7;
    --line:#6b5b3e;
    --muted:#bdb6a8;

    --allies:#c9b27c;
    --axis:#666666;
    --ussr:#b22222;
    --neutral:#888888;
    --custom:#d9d9d9;

    --weTint: rgba(201,178,124,.10);
    --eeTint: rgba(178,34,34,.10);
    --naTint: rgba(224,176,122,.10);
    --paTint: rgba(122,160,224,.10);
  }

  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  #topbar{
    position:fixed; inset:0 0 auto 0; z-index:1000;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    padding:10px 12px; background:#1b1b1b; border-bottom:2px solid #444;
  }
  #topbar .title{font-weight:700; letter-spacing:1px; margin-right:auto;}
  #topbar button, #topbar select{
    background:#222; color:#eee; border:1px solid #555; padding:6px 10px; cursor:pointer;
  }
  #topbar button:hover{background:#333;}

  #wrap{
    position:absolute; top:60px; left:0; right:390px; bottom:0;
    overflow:auto;
    background:
      radial-gradient(circle at 20% 10%, rgba(255,255,255,.04), transparent 40%),
      radial-gradient(circle at 80% 30%, rgba(255,255,255,.03), transparent 45%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.035), rgba(255,255,255,.035) 24px, rgba(255,255,255,.02) 24px, rgba(255,255,255,.02) 48px);
  }
  #board{
    position:relative;
    width:1600px; height:1100px;
    margin:30px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.10)), var(--paper);
    border:3px solid var(--line);
    box-shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* Edges overlay */
  #edges{
    position:absolute; inset:0;
    z-index:2;
    pointer-events:none;
  }
  .edgeLine{
    stroke: rgba(233,227,215,.25);
    stroke-width: 2;
  }
  .edgeLine.dim{
    stroke: rgba(233,227,215,.12);
  }
  .edgeLine.strong{
    stroke: rgba(233,227,215,.55);
    stroke-width: 3;
  }

  .theatre{
    position:absolute; z-index:1;
    border:2px dashed rgba(233,227,215,.25);
    border-radius:10px; overflow:hidden;
  }
  .theatreHeader{
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px;
    border-bottom:1px solid rgba(233,227,215,.18);
    background:rgba(0,0,0,.25);
    font-weight:700; letter-spacing:2px; font-size:13px;
  }
  .theatreBody{position:relative; height:100%;}

  #WE{left:40px;  top:40px;  width:740px; height:480px; background:var(--weTint);}
  #EE{left:820px; top:40px;  width:740px; height:480px; background:var(--eeTint);}
  #NA{left:40px;  top:560px; width:740px; height:480px; background:var(--naTint);}
  #PA{left:820px; top:560px; width:740px; height:480px; background:var(--paTint);}

  /* Territory piece */
  .node{
    position:absolute;
    width:28px; height:28px;
    border-radius:50%;
    border:2px solid #000;
    display:flex; align-items:center; justify-content:center;
    font-size:14px;
    cursor:pointer;
    user-select:none;
    box-shadow:0 2px 8px rgba(0,0,0,.35);
    z-index:3;
    transition: transform .08s ease, box-shadow .08s ease, outline-color .08s ease;
  }
  .node:hover{ transform: translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.45); }

  .owner-allies{background:var(--allies); color:#111;}
  .owner-axis{background:var(--axis); color:#111;}
  .owner-ussr{background:var(--ussr); color:#111;}
  .owner-neutral{background:var(--neutral); color:#111;}
  .owner-custom{background:var(--custom); color:#111;}

  /* Fog: greyed but still visible */
  .fog-unknown{ filter: grayscale(1); opacity: .35; }

  /* Selection */
  .selected{
    outline: 3px solid rgba(233,227,215,.70);
    outline-offset: 2px;
  }
  .adjacent{
    outline: 3px solid rgba(233,227,215,.35);
    outline-offset: 2px;
  }

  /* Right drawer */
  #panel{
    position:fixed; top:60px; right:0; bottom:0; width:390px;
    background:#171717; border-left:2px solid #444;
    padding:12px; overflow:auto; display:none;
  }
  #panel h2{margin:0 0 8px 0; font-size:16px;}
  .meta{color:var(--muted); font-size:12px; margin-bottom:10px;}
  .row{margin:10px 0;}
  .row label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px;}
  .row select, .row textarea, .row input{
    width:100%; background:#222; color:#eee; border:1px solid #555; padding:6px 8px;
    box-sizing:border-box;
  }
  .row textarea{min-height:70px; resize:vertical;}
  .pill{
    display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.15);
    border-radius:999px; font-size:12px; color:#ddd; background:rgba(0,0,0,.25);
    margin-right:6px;
  }
  .btnRow{display:flex; gap:10px; margin-top:10px;}
  .btnRow button{flex:1;}
  .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.4;}
  .linkish{ color:#e9e3d7; text-decoration:underline; cursor:pointer; }
  .linkish:hover{ opacity:.85; }

  .grid2{
    display:grid;
    grid-template-columns: 90px 1fr;
    gap:6px 8px;
    align-items:center;
  }
  .grid2 .tag{
    font-size:12px;
    color:var(--muted);
  }

  .hr{height:1px;background:rgba(255,255,255,.08); margin:14px 0;}
</style>
</head>

<body>
  <div id="topbar">
    <div class="title">WAR! Campaign — Strategic Board</div>

    <label style="color:var(--muted);font-size:12px;">Mode</label>
    <select id="modeSel">
      <option value="GM">GM</option>
      <option value="PLAYER">Player</option>
    </select>

    <label style="color:var(--muted);font-size:12px;">Player Faction</label>
    <select id="playerFactionSel">
      <option value="allies">Allies</option>
      <option value="axis">Axis</option>
      <option value="ussr">USSR</option>
      <option value="custom">Custom</option>
    </select>

    <label style="color:var(--muted);font-size:12px;">Adjacency</label>
    <select id="adjSel">
      <option value="off">Off</option>
      <option value="select" selected>On Select</option>
      <option value="always">Always</option>
    </select>

    <button onclick="jump('WE')">Western Europe</button>
    <button onclick="jump('EE')">Eastern Europe</button>
    <button onclick="jump('NA')">North Africa</button>
    <button onclick="jump('PA')">Pacific</button>

    <button onclick="exportState()">Export State</button>
    <button onclick="importState()">Import State</button>
    <button onclick="resetState()">Reset</button>
  </div>

  <div id="wrap">
    <div id="board">
      <svg id="edges"></svg>

      <div id="WE" class="theatre">
        <div class="theatreHeader"><span>WESTERN EUROPE</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="WE"></div>
      </div>

      <div id="EE" class="theatre">
        <div class="theatreHeader"><span>EASTERN EUROPE</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="EE"></div>
      </div>

      <div id="NA" class="theatre">
        <div class="theatreHeader"><span>NORTH AFRICA</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="NA"></div>
      </div>

      <div id="PA" class="theatre">
        <div class="theatreHeader"><span>PACIFIC</span><span class="pill">14</span></div>
        <div class="theatreBody" data-theatre="PA"></div>
      </div>
    </div>
  </div>

  <aside id="panel">
    <h2 id="pTitle"></h2>
    <div class="meta">
      <span class="pill" id="pTheatre"></span>
      <span class="pill" id="pId"></span>
    </div>

    <div class="row">
      <label>Adjacency</label>
      <div id="adjList" class="hint"></div>
      <div class="hint">Tip: click a neighbour to jump/highlight.</div>
    </div>

    <div class="hr"></div>

    <!-- Movement Helper -->
    <div class="row">
      <label>Movement Helper</label>
      <div class="hint">
        <div><span class="pill">From</span> <span id="mvFrom">—</span></div>
        <div style="margin-top:6px;"><span class="pill">To</span> <span id="mvTo">—</span></div>
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <button onclick="setMoveFromCurrent()">Set as Origin</button>
        <button onclick="trySetMoveToCurrent()">Set as Destination</button>
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <button onclick="logMove()">Log Move</button>
        <button onclick="clearMove()">Clear</button>
      </div>
      <div id="mvHint" class="hint"></div>
      <div id="mvOptions" class="hint" style="margin-top:10px;"></div>
    </div>

    <div class="hr"></div>

    <div id="playerInfo" class="row" style="display:none;">
      <div class="hint">
        Player view: Unknown territories stay visible but greyed.
      </div>
    </div>

    <div id="gmControls" style="display:none;">
      <div class="row">
        <label>Owner</label>
        <select id="ownerSel">
          <option value="neutral">Neutral</option>
          <option value="allies">Allies</option>
          <option value="axis">Axis</option>
          <option value="ussr">USSR</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div class="row">
        <label>Visibility (per faction)</label>
        <div class="grid2">
          <div class="tag">Allies</div>
          <select id="visAllies">
            <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
          </select>

          <div class="tag">Axis</div>
          <select id="visAxis">
            <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
          </select>

          <div class="tag">USSR</div>
          <select id="visUSSR">
            <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
          </select>

          <div class="tag">Custom</div>
          <select id="visCustom">
            <option>Unknown</option><option>Known</option><option>Observed</option><option>Confirmed</option>
          </select>
        </div>
        <div class="hint" style="margin-top:8px;">
          Labels are fixed: Allies / Axis / USSR / Custom.
        </div>
      </div>

      <div class="row">
        <label>GM Notes</label>
        <textarea id="notes"></textarea>
      </div>

      <div class="btnRow">
        <button onclick="saveTerritory()">Save</button>
        <button onclick="closePanel()">Close</button>
      </div>
    </div>

    <div class="hint" style="margin-top:14px;">
      Icons: ★ Allies, ✚ Axis, ☭ USSR, ⚑ Custom, ● Neutral
    </div>
  </aside>

<script>
/** Fixed positions (14 slots) used in every theatre panel */
const POS14 = [
  [140,120],[220,90],[320,100],[430,90],
  [120,200],[220,190],[330,200],[450,190],
  [140,280],[240,300],[340,290],[440,300],
  [200,370],[360,370]
];

const THEATRE_NAME = {WE:"Western Europe", EE:"Eastern Europe", NA:"North Africa", PA:"Pacific"};
const OWNER_ICON = {allies:"★", axis:"✚", ussr:"☭", neutral:"●", custom:"⚑"};
const STORAGE_KEY = "war_board_state_v2";

/**
 * TERRS with adjacency
 * NOTE: This adjacency comes from the extracted prototype JSON.
 */
const TERRS = [{"id":"EE-01","name":"Western Poland","theatreKey":"EE","adj":["EE-02"]},{"id":"EE-02","name":"Eastern Poland","theatreKey":"EE","adj":["EE-01","EE-03"]},{"id":"EE-03","name":"Baltic States","theatreKey":"EE","adj":["EE-02","EE-04"]},{"id":"EE-04","name":"Belarus","theatreKey":"EE","adj":["EE-03","EE-05"]},{"id":"EE-05","name":"Ukraine (West)","theatreKey":"EE","adj":["EE-04","EE-06"]},{"id":"EE-06","name":"Ukraine (East)","theatreKey":"EE","adj":["EE-05","EE-07","EE-11"]},{"id":"EE-07","name":"Crimea","theatreKey":"EE","adj":["EE-06","EE-08"]},{"id":"EE-08","name":"Moscow","theatreKey":"EE","adj":["EE-07","EE-09"]},{"id":"EE-09","name":"Leningrad","theatreKey":"EE","adj":["EE-08","EE-10"]},{"id":"EE-10","name":"Smolensk Corridor","theatreKey":"EE","adj":["EE-09","EE-11"]},{"id":"EE-11","name":"Caucasus","theatreKey":"EE","adj":["EE-10","EE-12","EE-06"]},{"id":"EE-12","name":"Stalingrad","theatreKey":"EE","adj":["EE-11","EE-13"]},{"id":"EE-13","name":"Arctic Front","theatreKey":"EE","adj":["EE-12","EE-14"]},{"id":"EE-14","name":"Volga Belt","theatreKey":"EE","adj":["EE-13"]},{"id":"NA-01","name":"Algeria Coast","theatreKey":"NA","adj":["NA-02"]},{"id":"NA-02","name":"Tunis","theatreKey":"NA","adj":["NA-01","NA-03"]},{"id":"NA-03","name":"Tripoli","theatreKey":"NA","adj":["NA-02","NA-04"]},{"id":"NA-04","name":"Benghazi","theatreKey":"NA","adj":["NA-03","NA-05"]},{"id":"NA-05","name":"Tobruk","theatreKey":"NA","adj":["NA-04","NA-06"]},{"id":"NA-06","name":"El Alamein","theatreKey":"NA","adj":["NA-05","NA-07"]},{"id":"NA-07","name":"Alexandria","theatreKey":"NA","adj":["NA-06","NA-08"]},{"id":"NA-08","name":"Western Desert","theatreKey":"NA","adj":["NA-07","NA-09"]},{"id":"NA-09","name":"Southern Desert","theatreKey":"NA","adj":["NA-08","NA-10"]},{"id":"NA-10","name":"Fezzan","theatreKey":"NA","adj":["NA-09","NA-11"]},{"id":"NA-11","name":"Siwa Oasis","theatreKey":"NA","adj":["NA-10","NA-12"]},{"id":"NA-12","name":"Cairo Corridor","theatreKey":"NA","adj":["NA-11","NA-13"]},{"id":"NA-13","name":"Med Sea Lanes","theatreKey":"NA","adj":["NA-12","NA-14"]},{"id":"NA-14","name":"Red Sea Approaches","theatreKey":"NA","adj":["NA-13"]},{"id":"PA-01","name":"Midway","theatreKey":"PA","adj":["PA-02"]},{"id":"PA-02","name":"Wake / Johnston","theatreKey":"PA","adj":["PA-01","PA-03"]},{"id":"PA-03","name":"Marshall Is.","theatreKey":"PA","adj":["PA-02","PA-04"]},{"id":"PA-04","name":"Gilbert Is.","theatreKey":"PA","adj":["PA-03","PA-05"]},{"id":"PA-05","name":"Caroline Is.","theatreKey":"PA","adj":["PA-04","PA-06"]},{"id":"PA-06","name":"Guam (sea lanes)","theatreKey":"PA","adj":["PA-05","PA-07"]},{"id":"PA-07","name":"Mariana Is.","theatreKey":"PA","adj":["PA-06","PA-08"]},{"id":"PA-08","name":"Philippines","theatreKey":"PA","adj":["PA-07","PA-09","PA-13"]},{"id":"PA-09","name":"Solomon Is.","theatreKey":"PA","adj":["PA-08","PA-10"]},{"id":"PA-10","name":"New Guinea","theatreKey":"PA","adj":["PA-09","PA-11"]},{"id":"PA-11","name":"Fiji","theatreKey":"PA","adj":["PA-10","PA-12"]},{"id":"PA-12","name":"N. Australia","theatreKey":"PA","adj":["PA-11","PA-14"]},{"id":"PA-13","name":"Formosa","theatreKey":"PA","adj":["PA-08"]},{"id":"PA-14","name":"Pacific Sea Lanes","theatreKey":"PA","adj":["PA-12"]},{"id":"WE-01","name":"Southern England","theatreKey":"WE","adj":["WE-02"]},{"id":"WE-02","name":"Northern France","theatreKey":"WE","adj":["WE-01","WE-03"]},{"id":"WE-03","name":"Benelux","theatreKey":"WE","adj":["WE-02","WE-04"]},{"id":"WE-04","name":"Western Germany","theatreKey":"WE","adj":["WE-03","WE-05"]},{"id":"WE-05","name":"Berlin Region","theatreKey":"WE","adj":["WE-04","WE-06"]},{"id":"WE-06","name":"Denmark / Norway Sea Lane","theatreKey":"WE","adj":["WE-05","WE-07"]},{"id":"WE-07","name":"Northern Italy","theatreKey":"WE","adj":["WE-06","WE-08"]},{"id":"WE-08","name":"Central Italy","theatreKey":"WE","adj":["WE-07","WE-09"]},{"id":"WE-09","name":"Southern Italy","theatreKey":"WE","adj":["WE-08","WE-10"]},{"id":"WE-10","name":"Iberian Peninsula","theatreKey":"WE","adj":["WE-09","WE-11"]},{"id":"WE-11","name":"Western Mediterranean Coast","theatreKey":"WE","adj":["WE-10","WE-12"]},{"id":"WE-12","name":"Scandinavia (South)","theatreKey":"WE","adj":["WE-11","WE-13"]},{"id":"WE-13","name":"Atlantic Sea Lanes","theatreKey":"WE","adj":["WE-12","WE-14"]},{"id":"WE-14","name":"Alpine Region","theatreKey":"WE","adj":["WE-13"]}];

const byId = new Map(TERRS.map(t => [t.id, t]));
const board = document.getElementById("board");
const edgesSvg = document.getElementById("edges");
const modeSel = document.getElementById("modeSel");
const playerFactionSel = document.getElementById("playerFactionSel");
const adjSel = document.getElementById("adjSel");

let state = loadState();
let currentId = null;

/* Movement helper state (not per-territory) */
let moveFrom = null;
let moveTo = null;

modeSel.addEventListener("change", () => {
  applyMode();
  rerenderFog();
  redrawEdges();
  refreshMoveUI();
});

playerFactionSel.addEventListener("change", () => {
  rerenderFog();
  redrawEdges();
  refreshMoveUI();
});

adjSel.addEventListener("change", () => {
  redrawEdges();
});

function jump(key){
  document.getElementById(key).scrollIntoView({behavior:"smooth", block:"start", inline:"nearest"});
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      // Backfill missing fields
      for(const t of TERRS){
        if(!parsed[t.id]) parsed[t.id] = {};
        parsed[t.id].owner = parsed[t.id].owner || "neutral";
        parsed[t.id].vis = parsed[t.id].vis || {allies:"Known", axis:"Known", ussr:"Known", custom:"Known"};
        parsed[t.id].notes = parsed[t.id].notes || "";
      }
      // Meta
      if(!parsed._meta) parsed._meta = {turn:1, moveLog:[]};
      if(typeof parsed._meta.turn !== "number") parsed._meta.turn = 1;
      if(!Array.isArray(parsed._meta.moveLog)) parsed._meta.moveLog = [];
      return parsed;
    }
  }catch(e){}
  const s = {};
  for(const t of TERRS){
    s[t.id] = {
      owner:"neutral",
      vis:{allies:"Known", axis:"Known", ussr:"Known", custom:"Known"},
      notes:""
    };
  }
  s._meta = {turn:1, moveLog:[]};
  return s;
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function resetState(){
  if(!confirm("Reset all campaign state on this device?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = loadState();
  closePanel();
  clearMove();
  renderAll();
}

function exportState(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "war_state.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importState(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = () => {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        state = parsed;
        // Backfill essentials
        state = loadState(); // will merge/backfill from localstorage; so we do a simple swap:
        // Instead do manual merge:
      }catch(e){}
      try{
        const parsed2 = JSON.parse(reader.result);
        // merge parsed2 into fresh defaults
        const fresh = loadState();
        for(const k of Object.keys(parsed2)){
          fresh[k] = parsed2[k];
        }
        state = fresh;
        saveState();
        closePanel();
        renderAll();
      }catch(e){
        alert("Invalid JSON.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function applyMode(){
  const mode = modeSel.value;
  document.getElementById("gmControls").style.display = (mode==="GM") ? "block" : "none";
  document.getElementById("playerInfo").style.display = (mode==="PLAYER") ? "block" : "none";
}

function nodeClassFor(owner){
  return `node owner-${owner}`;
}

function clearHighlights(){
  document.querySelectorAll(".node").forEach(n => {
    n.classList.remove("selected");
    n.classList.remove("adjacent");
  });
}

function rerenderFog(){
  const mode = modeSel.value;
  const faction = playerFactionSel.value;
  document.querySelectorAll(".node").forEach(el => {
    const tid = el.dataset.id;
    const st = state[tid];
    el.classList.remove("fog-unknown");
    if(mode === "PLAYER"){
      const v = (st && st.vis && st.vis[faction]) ? st.vis[faction] : "Unknown";
      if(v === "Unknown") el.classList.add("fog-unknown");
    }
  });
  if(currentId) refreshPanel(currentId);
}

function renderAll(){
  document.querySelectorAll(".theatreBody").forEach(b => b.innerHTML = "");
  clearEdges();
  clearHighlights();

  const byTheatre = {WE:[], EE:[], NA:[], PA:[]};
  for(const t of TERRS) if(t.id !== "_meta") byTheatre[t.theatreKey].push(t);

  for(const key of Object.keys(byTheatre)){
    const body = document.querySelector(`.theatreBody[data-theatre="${key}"]`);
    const list = byTheatre[key];
    list.sort((a,b)=> a.id.localeCompare(b.id));

    list.forEach((t, idx) => {
      const [x,y] = POS14[idx];
      const st = state[t.id];
      const el = document.createElement("div");
      el.className = nodeClassFor(st.owner);
      el.style.left = x + "px";
      el.style.top = y + "px";
      el.textContent = OWNER_ICON[st.owner] || "●";
      el.dataset.id = t.id;
      el.dataset.theatre = key;
      el.title = `${t.id} — ${t.name}`;
      el.addEventListener("click", () => openPanel(t.id));
      body.appendChild(el);
    });
  }

  applyMode();
  rerenderFog();
  redrawEdges();
  refreshMoveUI();
}

/* --- Adjacency drawing --- */
function clearEdges(){
  while(edgesSvg.firstChild) edgesSvg.removeChild(edgesSvg.firstChild);
}

function nodeCenter(id){
  const el = document.querySelector(`.node[data-id="${id}"]`);
  if(!el) return null;
  const b = board.getBoundingClientRect();
  const r = el.getBoundingClientRect();
  return {
    x: (r.left - b.left) + r.width/2,
    y: (r.top  - b.top)  + r.height/2
  };
}

function drawLine(aId, bId, cls){
  const a = nodeCenter(aId);
  const b = nodeCenter(bId);
  if(!a || !b) return;

  const line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1", a.x); line.setAttribute("y1", a.y);
  line.setAttribute("x2", b.x); line.setAttribute("y2", b.y);
  line.setAttribute("class", cls);
  edgesSvg.appendChild(line);
}

function redrawEdges(){
  edgesSvg.setAttribute("width", board.clientWidth);
  edgesSvg.setAttribute("height", board.clientHeight);
  edgesSvg.setAttribute("viewBox", `0 0 ${board.clientWidth} ${board.clientHeight}`);

  const mode = adjSel.value;
  clearEdges();

  if(mode === "off") return;

  if(mode === "always"){
    const seen = new Set();
    for(const t of TERRS){
      for(const n of t.adj){
        const key = [t.id, n].sort().join("|");
        if(seen.has(key)) continue;
        seen.add(key);
        drawLine(t.id, n, "edgeLine");
      }
    }
    return;
  }

  if(currentId){
    highlightAdjacency(currentId);
  }
}

function highlightAdjacency(id){
  clearEdges();
  clearHighlights();

  const t = byId.get(id);
  if(!t) return;

  const selectedEl = document.querySelector(`.node[data-id="${id}"]`);
  if(selectedEl) selectedEl.classList.add("selected");

  const mode = modeSel.value;
  const faction = playerFactionSel.value;

  for(const n of t.adj){
    const nEl = document.querySelector(`.node[data-id="${n}"]`);
    if(nEl) nEl.classList.add("adjacent");

    let cls = "edgeLine strong";
    if(mode === "PLAYER"){
      const st = state[n];
      const vis = (st && st.vis && st.vis[faction]) ? st.vis[faction] : "Unknown";
      if(vis === "Unknown") cls = "edgeLine dim";
    }
    drawLine(id, n, cls);
  }

  // Also show movement helper options if we have an origin
  refreshMoveUI();
}

/* --- Panel --- */
function openPanel(id){
  currentId = id;
  refreshPanel(id);
  document.getElementById("panel").style.display = "block";

  if(adjSel.value === "select"){
    highlightAdjacency(id);
  }else{
    clearHighlights();
    const el = document.querySelector(`.node[data-id="${id}"]`);
    if(el) el.classList.add("selected");
  }
  refreshMoveUI();
}

function closePanel(){
  currentId = null;
  document.getElementById("panel").style.display = "none";
  clearHighlights();
  redrawEdges();
}

function refreshPanel(id){
  const t = byId.get(id);
  if(!t) return;
  const st = state[id];

  document.getElementById("pTitle").textContent = t.name;
  document.getElementById("pTheatre").textContent = THEATRE_NAME[t.theatreKey];
  document.getElementById("pId").textContent = t.id;

  // adjacency list with links
  const adjList = document.getElementById("adjList");
  if(!t.adj || !t.adj.length){
    adjList.textContent = "None";
  }else{
    adjList.innerHTML = "";
    t.adj.forEach((nid, i) => {
      const nt = byId.get(nid);
      const span = document.createElement("span");
      span.className = "linkish";
      span.textContent = nt ? `${nid} — ${nt.name}` : nid;
      span.onclick = () => {
        const nk = nt ? nt.theatreKey : nid.split("-")[0];
        jump(nk);
        setTimeout(() => openPanel(nid), 250);
      };
      adjList.appendChild(span);
      if(i < t.adj.length-1) adjList.appendChild(document.createTextNode(" • "));
    });
  }

  // GM fields
  const mode = modeSel.value;
  if(mode === "GM"){
    document.getElementById("ownerSel").value = st.owner;
    document.getElementById("visAllies").value = st.vis.allies || "Known";
    document.getElementById("visAxis").value = st.vis.axis || "Known";
    document.getElementById("visUSSR").value = st.vis.ussr || "Known";
    document.getElementById("visCustom").value = st.vis.custom || "Known";
    document.getElementById("notes").value = st.notes || "";
  }
}

/* --- Save territory --- */
function saveTerritory(){
  if(!currentId) return;
  const st = state[currentId];
  st.owner = document.getElementById("ownerSel").value;
  st.vis = {
    allies: document.getElementById("visAllies").value,
    axis: document.getElementById("visAxis").value,
    ussr: document.getElementById("visUSSR").value,
    custom: document.getElementById("visCustom").value
  };
  st.notes = document.getElementById("notes").value || "";
  saveState();

  const node = document.querySelector(`.node[data-id="${currentId}"]`);
  if(node){
    node.className = nodeClassFor(st.owner);
    node.textContent = OWNER_ICON[st.owner] || "●";
  }
  rerenderFog();

  if(adjSel.value === "select"){
    highlightAdjacency(currentId);
  }else{
    redrawEdges();
  }
}

/* -------------------------
   Movement Helper
-------------------------- */
function setMoveFromCurrent(){
  if(!currentId) return;
  moveFrom = currentId;
  // If destination no longer valid, clear it
  if(moveTo && !isAdjacent(moveFrom, moveTo)) moveTo = null;
  refreshMoveUI();
  // Highlight adjacency of origin to make move options obvious
  if(adjSel.value === "select") highlightAdjacency(moveFrom);
}

function trySetMoveToCurrent(){
  if(!currentId) return;
  if(!moveFrom){
    setMoveFromCurrent();
    return;
  }
  if(currentId === moveFrom){
    moveTo = null;
    refreshMoveUI();
    return;
  }
  if(isAdjacent(moveFrom, currentId)){
    moveTo = currentId;
  } else {
    setMoveHint(`Not adjacent: ${moveFrom} → ${currentId}. Choose a highlighted neighbour.`);
    moveTo = null;
  }
  refreshMoveUI();
}

function isAdjacent(a, b){
  const ta = byId.get(a);
  if(!ta) return false;
  return (ta.adj || []).includes(b);
}

function clearMove(){
  moveFrom = null;
  moveTo = null;
  setMoveHint("");
  refreshMoveUI();
}

function setMoveHint(msg){
  document.getElementById("mvHint").textContent = msg || "";
}

function refreshMoveUI(){
  const fromEl = document.getElementById("mvFrom");
  const toEl = document.getElementById("mvTo");
  const optionsEl = document.getElementById("mvOptions");

  const fromT = moveFrom ? byId.get(moveFrom) : null;
  const toT = moveTo ? byId.get(moveTo) : null;

  fromEl.textContent = fromT ? `${moveFrom} — ${fromT.name}` : "—";
  toEl.textContent = toT ? `${moveTo} — ${toT.name}` : "—";

  // Options list: valid destinations from origin
  optionsEl.innerHTML = "";
  if(moveFrom){
    const ta = byId.get(moveFrom);
    const title = document.createElement("div");
    title.className = "hint";
    title.textContent = "Valid destinations:";
    optionsEl.appendChild(title);

    const list = document.createElement("div");
    (ta.adj || []).forEach((nid, i) => {
      const nt = byId.get(nid);
      const span = document.createElement("span");
      span.className = "linkish";
      span.textContent = nt ? `${nid} — ${nt.name}` : nid;
      span.onclick = () => {
        moveTo = nid;
        const nk = nt ? nt.theatreKey : nid.split("-")[0];
        jump(nk);
        setTimeout(() => openPanel(nid), 250);
        refreshMoveUI();
      };
      list.appendChild(span);
      if(i < ta.adj.length-1) list.appendChild(document.createTextNode(" • "));
    });
    optionsEl.appendChild(list);

    // Clear stale hint if now valid
    if(moveTo && !isAdjacent(moveFrom, moveTo)){
      moveTo = null;
      setMoveHint(`Destination cleared (not adjacent).`);
    }
  } else {
    optionsEl.textContent = "Set an origin to see valid destinations.";
  }
}

function logMove(){
  const mode = modeSel.value;
  if(!moveFrom || !moveTo){
    setMoveHint("Set both Origin and Destination first.");
    return;
  }
  if(!isAdjacent(moveFrom, moveTo)){
    setMoveHint("Invalid move (not adjacent).");
    return;
  }

  // Allow planning in Player mode, but only GM can write to log
  if(mode !== "GM"){
    setMoveHint("Player mode: move planned (not logged). Switch to GM to log.");
    return;
  }

  const meta = state._meta || (state._meta = {turn:1, moveLog:[]});
  const entry = {
    turn: meta.turn || 1,
    from: moveFrom,
    to: moveTo,
    ts: new Date().toISOString()
  };
  meta.moveLog.push(entry);
  saveState();
  setMoveHint(`Logged: Turn ${entry.turn} — ${entry.from} → ${entry.to}`);
}

renderAll();
window.addEventListener("resize", () => redrawEdges());
</script>
</body>
</html>
